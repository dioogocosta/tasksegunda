<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas Segunda</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4285F4">
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
		
        /* Remover marcadores de lista */
        .accordion-content ul {
            list-style: none;
            padding-left: 0;
        }
		
        /* Melhorar bot√£o de edi√ß√£o */
        .edit-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            margin-left: 8px;
            padding: 4px;
            border-radius: 4px;
        }
        
        .edit-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* IN√çCIO - NOVOS ESTILOS PARA TAREFAS IMPORTADAS */
        /* Estilo para tarefas importadas */
        .imported-task {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 4px solid #6c757d;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .imported-task:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-source {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        /* FIM - NOVOS ESTILOS */

        /* Header */
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
		
        .accordion-header-content {
            display: flex;
            align-items: center;
            flex: 1;
        }
		
        .menu-icon {
            display: inline-block;
        }

        .menu-text {
            display: inline-block;
        }

        @media (max-width: 768px) {
            .menu-text {
                display: none;
            }
        }
		
        .dragging {
            opacity: 0.5;
            background: #e9ecef;
            border: 2px dashed #4285F4;
        }

        .task-item {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .task-actions {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
        }

        .drag-handle {
            margin-right: 10px;
            cursor: move;
            color: #666;
            user-select: none;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: #4285F4;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        .app-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .search-input:focus {
            border-color: #4285F4;
            background: white;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .menu-button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        .menu-button:hover {
            background: #3367d6;
            transform: translateY(-1px);
        }

        /* Modal lateral */
        .sidebar-modal {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-modal.open {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1500;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .close-button:hover {
            color: #333;
        }

        /* Bot√µes do modal */
        .modal-button {
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
        }

        .btn-primary:hover {
            background: #34495e;
        }

        .btn-secondary {
            background: #4285F4;
            color: white;
        }

        .btn-secondary:hover {
            background: #3367d6;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #fd7e14;
            color: white;
        }

        .btn-warning:hover {
            background: #e8590c;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Accordion */
        .accordion {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .accordion-header {
            background: #f8f9fa;
            padding: 20px;
            cursor: pointer;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-header.active {
            background: #4285F4;
            color: white;
        }

        .accordion-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accordion-content {
            padding: 20px;
            display: none;
        }

        .accordion-content.active {
            display: block;
        }

        /* Tarefas */
        .task-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #4285F4;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .task-date {
            color: #999;
            font-size: 12px;
        }

        /* Ajustes para tarefas importadas - Responsivo */
        .imported-task .task-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
        }

        .imported-task .task-info {
            flex: 1;
            min-width: 0;
        }

        /* Ajustes para mobile */
        @media (max-width: 767px) {
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-content {
                flex-direction: row;
                align-items: center;
            }
            
            .task-drag-handle {
                margin-bottom: 0;
                margin-right: 8px;
            }
            
            .task-actions {
                margin-top: 8px;
                align-self: flex-end;
            }
        }       

        .task-menu-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            color: #666;
            transition: all 0.3s ease;
        }

        .task-menu-button:hover {
            background: #e9ecef;
            color: #333;
        }

        .task-action-buttons {
            position: absolute;
            right: 0;
            top: 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
            flex-direction: row;
        }

        .task-action-buttons.show {
            display: flex;
        }

        .task-action-btn {
            margin: 0 3px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
        }

        .task-action-btn:hover {
            transform: scale(1.1);
        }

        .btn-complete {
            color: #28a745;
        }

        .btn-favorite {
            color: #ffc107;
        }

        .btn-edit {
            color: #007bff;
        }

        .btn-delete {
            color: #dc3545;
        }

        /* Rodap√© */
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #e1e5e9;
            margin-top: 40px;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px 15px;
            }

            .logo-section {
                order: 1;
                flex: 1;
            }

            .search-container {
                order: 3;
                width: 100%;
                margin: 0;
                min-width: 0;
            }

            .menu-button {
                order: 2;
                padding: 10px;
                font-size: 16px;
            }

            .menu-button::before {
                content: "‚ò∞";
            }

            .menu-button span {
                display: none;
            }

            @media (max-width: 400px) {
                .logo-section {
                    flex: 100%;
                }
                
                .menu-button {
                    order: 1;
                }
            }
        }

        /* Anima√ß√µes */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Estados das tarefas */
        .task-completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .task-completed .task-title {
            color: #28a745;
        }

        /* Bot√£o Nova Tarefa */
        .new-task-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            margin-bottom: 20px;
        }

        .new-task-button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Modal de nova tarefa */
        .task-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .task-modal.show {
            display: flex;
        }

        .task-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .task-modal-header {
            margin-bottom: 20px;
        }

        .task-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #4285F4;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: #4285F4;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #3367d6;
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #5a6268;
        }

        /* Status message */
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        .status.error {
            background: #dc3545;
        }

        /* Drag and Drop styles */
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin: 10px 0;
            padding: 10px;
            text-align: center;
            color: #666;
            display: none;
            background: #f8f9fa;
        }

        .drop-zone.active {
            display: block;
            border-color: #4285F4;
            background-color: #f0f8ff;
        }

        .drop-zone.hover {
            border-color: #28a745;
            background-color: #f0fff0;
        }

        /* Drop indicator */
        .drop-indicator {
            height: 3px;
            background-color: #4285F4;
            margin: 5px 0;
            border-radius: 2px;
            display: none;
            opacity: 0.8;
        }

        .drop-indicator.active {
            display: block;
        }

        /* Task drop indicators */
        .task-drop-indicator {
            height: 3px;
            background-color: #4285F4;
            margin: 2px 0;
            border-radius: 2px;
            display: none;
            opacity: 0.8;
        }

        .task-drop-indicator.active {
            display: block;
        }

        .task-drop-indicator-top {
            margin-bottom: 2px;
        }

        .task-drop-indicator-bottom {
            margin-top: 2px;
        }

        /* Ajustar drag handle */
        .task-drag-handle {
            cursor: move;
            margin-right: 8px;
            color: #666;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            padding: 2px 5px;
            border-radius: 4px;
            background: #e9ecef;
            font-size: 12px;
        }

        .task-drag-handle:hover {
            background: #dee2e6;
        }

        /* Highlight for search */
        .highlight {
            background-color: yellow;
            padding: 2px 0;
        }

        /* Star for favorites */
        .star {
            cursor: pointer;
            margin-right: 8px;
            color: gray;
            font-size: 16px;
        }

        .star.favorited {
            color: gold;
        }

        /* Confirm icon */
        .confirm-icon {
            cursor: pointer;
            margin-right: 8px;
            color: #28a745;
            font-size: 16px;
        }

        /* Trash icon */
        .trash-icon {
            cursor: pointer;
            margin-right: 8px;
            color: #dc3545;
            font-size: 16px;
        }

        /* Edit form */
        .edit-form {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
        }

        .edit-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        /* Mobile optimized buttons */
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            padding: 0;
            margin: 2px;
        }
        
        .action-btn-success {
            background-color: #28a745;
        }
        
        .action-btn-primary {
            background-color: #007bff;
        }
        
        .action-btn-danger {
            background-color: #dc3545;
        }
        
        .action-btn-warning {
            background-color: #ffc107;
            color: black;
        }
        
        /* Desktop buttons */
        @media (min-width: 768px) {
            .action-btn {
                width: auto;
                height: auto;
                padding: 5px 10px;
                font-size: 12px;
                border-radius: 4px;
            }
            
            .action-btn::before {
                content: attr(data-text);
            }
        }
        
        /* Mobile - icons only */
        @media (max-width: 767px) {
            .task-actions {
                gap: 2px;
            }
            
            .action-btn::before {
                content: attr(data-icon);
            }
        }
    </style>
</head>
<body>
    <!-- Status message -->
    <div id="status" class="status">PWA Instalado!</div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">T</div>
                <h1 class="app-title">Tarefas Segunda</h1>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Buscar tarefas..." id="search">
            </div>
            
            <button class="menu-button" onclick="toggleSidebar()">
                <span class="menu-icon">‚ò∞</span>
                <span class="menu-text">Menu</span>
            </button>
        </div>
    </header>

    <!-- Modal Lateral -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar-modal" id="sidebarModal">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Menu de A√ß√µes</h2>
            <button class="close-button" onclick="closeSidebar()">√ó</button>
        </div>
        
        <button class="modal-button btn-primary" onclick="document.getElementById('upload').click()">
            üìÑ Carregar Documento Word
        </button>
        
        <button class="modal-button btn-secondary" onclick="exportFavoritosJSON()">
            üìã Exportar Favoritos + Minhas Tarefas (JSON)
        </button>
        
        <button class="modal-button btn-secondary" onclick="exportFavoritosCSV()">
            üìä Exportar Favoritos (CSV)
        </button>
        
        <button class="modal-button btn-success" onclick="exportDatabase()">
            üíæ Backup SQLite
        </button>
        
        <button class="modal-button btn-warning" onclick="importDatabase()">
            üîÑ Restaurar SQLite
        </button>
        
        <button class="modal-button btn-danger" onclick="clearWordData()">
            üóëÔ∏è Limpar Dados do Word
        </button>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <div id="accordion-container"></div>
    </div>

    <!-- Modal de Nova Tarefa -->
    <div class="task-modal" id="taskModal">
        <div class="task-modal-content">
            <div class="task-modal-header">
                <h3 class="task-modal-title">Nova Tarefa</h3>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskTitle">T√≠tulo</label>
                <input type="text" class="form-input" id="taskTitle" placeholder="Digite o t√≠tulo da tarefa">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskDescription">Descri√ß√£o</label>
                <textarea class="form-input form-textarea" id="taskDescription" placeholder="Digite a descri√ß√£o da tarefa"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeTaskModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="salvarNovaTarefa()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Inputs ocultos -->
    <input type="file" id="upload" accept=".docx" style="display: none;">
    <input type="file" id="restore" accept=".sqlite,.json" style="display: none;">

    <!-- Rodap√© -->
    <footer class="footer">
        Tarefas Segunda v1.0.6 - 16/07/2025
    </footer>

    <script>
        // Vari√°veis globais
        let tarefasPorPessoa = {};
        let db = null;
        let SQL = null;
        let sqliteReady = false;
        let accordionOrder = ['minhas-tarefas', 'lista-favoritos'];
        let accordionStates = {};
        let draggedElement = null;
        let draggedType = null;
        let draggedIndex = -1;
        let draggedSource = null;
        let minhasTarefas = [];
        let favoritos = [];
        let editandoTarefa = null;

        // Fun√ß√£o para mostrar status
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'status error' : 'status';
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // Fun√ß√µes para gerenciar estado dos acorde√µes
        function saveAccordionState(accordionId, isOpen) {
            accordionStates[accordionId] = isOpen;
            localStorage.setItem('accordionStates', JSON.stringify(accordionStates));
        }

        function getAccordionState(accordionId) {
            return accordionStates[accordionId] !== undefined ? accordionStates[accordionId] : accordionId === 'minhas-tarefas'; // Padr√£o: minhas-tarefas aberto, outros fechados
        }

        function loadAccordionStates() {
            const saved = localStorage.getItem('accordionStates');
            if (saved) {
                accordionStates = JSON.parse(saved);
            }
        }

        // Fun√ß√µes do modal lateral
        function toggleSidebar() {
            const modal = document.getElementById('sidebarModal');
            const overlay = document.getElementById('sidebarOverlay');
            
            modal.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function closeSidebar() {
            const modal = document.getElementById('sidebarModal');
            const overlay = document.getElementById('sidebarOverlay');
            
            modal.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Fun√ß√µes do modal de tarefa
        function openTaskModal() {
            document.getElementById('taskModal').classList.add('show');
            document.getElementById('taskTitle').focus();
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            editandoTarefa = null;
        }

        function salvarNovaTarefa() {
            const titulo = document.getElementById('taskTitle').value.trim();
            const descricao = document.getElementById('taskDescription').value.trim();

            if (!titulo) {
                alert('Por favor, insira um t√≠tulo para a tarefa.');
                return;
            }

            if (editandoTarefa) {
                editarTarefa(editandoTarefa.id, titulo, descricao);
            } else {
                adicionarTarefa(titulo, descricao);
            }

            closeTaskModal();
        }

        // Fun√ß√£o para mostrar/ocultar bot√µes de a√ß√£o da tarefa
        function toggleTaskActions(taskId) {
            const buttons = document.getElementById(`actions-${taskId}`);
            const isVisible = buttons.classList.contains('show');
            
            // Ocultar todos os outros bot√µes primeiro
            document.querySelectorAll('.task-action-buttons').forEach(btn => {
                btn.classList.remove('show');
            });
            
            // Mostrar/ocultar os bot√µes da tarefa atual
            if (!isVisible) {
                buttons.classList.add('show');
            }
        }

        // Inicializar SQLite
        async function initSQLite() {
            try {
                if (!window.initSqlJs) {
                    await loadSqlJs();
                }
                
                SQL = await window.initSqlJs({
                    locateFile: file => {
                        if (file.endsWith('.wasm')) {
                            return 'sql-wasm.wasm';
                        }
                        return file;
                    }
                });
                
                const savedDb = localStorage.getItem('sqliteDb');
                if (savedDb) {
                    try {
                        const uint8Array = new Uint8Array(JSON.parse(savedDb));
                        db = new SQL.Database(uint8Array);
                    } catch (error) {
                        console.warn('Erro ao carregar banco salvo, criando novo:', error);
                        db = new SQL.Database();
                        createTables();
                    }
                } else {
                    db = new SQL.Database();
                    createTables();
                }
                
                sqliteReady = true;
                console.log('SQLite inicializado com sucesso');
                return true;
            } catch (error) {
                console.error('Erro ao inicializar SQLite:', error);
                sqliteReady = false;
                showStatus('SQLite n√£o dispon√≠vel, usando localStorage', true);
                return false;
            }
        }

        function loadSqlJs() {
            return new Promise((resolve, reject) => {
                if (window.initSqlJs) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'sql-wasm.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function createTables() {
            if (!db) return;
            
            try {
                db.run(`
                    CREATE TABLE IF NOT EXISTS minhas_tarefas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        titulo TEXT NOT NULL,
                        descricao TEXT,
                        concluida INTEGER DEFAULT 0,
                        data_criacao TEXT,
                        ordem INTEGER DEFAULT 0
                    )
                `);
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS favoritos (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        pessoa TEXT NOT NULL,
                        tarefa TEXT NOT NULL
                    )
                `);
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS tarefas_por_pessoa (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        pessoa TEXT NOT NULL,
                        tarefa TEXT NOT NULL
                    )
                `);
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS accordion_order (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        accordion_id TEXT NOT NULL,
                        position INTEGER NOT NULL
                    )
                `);
            } catch (error) {
                console.error('Erro ao criar tabelas:', error);
            }
        }

        function saveDatabase() {
            if (db && sqliteReady) {
                try {
                    const data = db.export();
                    localStorage.setItem('sqliteDb', JSON.stringify(Array.from(data)));
                } catch (error) {
                    console.error('Erro ao salvar banco:', error);
                }
            }
        }

        function saveTarefasPorPessoa() {
            if (db && sqliteReady) {
                try {
                    db.run("DELETE FROM tarefas_por_pessoa");
                    for (let pessoa in tarefasPorPessoa) {
                        tarefasPorPessoa[pessoa].forEach(tarefa => {
                            db.run("INSERT INTO tarefas_por_pessoa (pessoa, tarefa) VALUES (?, ?)", [pessoa, tarefa]);
                        });
                    }
                    saveDatabase();
                } catch (error) {
                    console.error('Erro ao salvar tarefasPorPessoa no SQLite:', error);
                    localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
                }
            } else {
                localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
            }
        }

        function saveAccordionOrder() {
            if (db && sqliteReady) {
                try {
                    db.run("DELETE FROM accordion_order");
                    accordionOrder.forEach((id, index) => {
                        db.run("INSERT INTO accordion_order (accordion_id, position) VALUES (?, ?)", [id, index]);
                    });
                    saveDatabase();
                } catch (error) {
                    console.error('Erro ao salvar ordem dos acorde√µes:', error);
                    localStorage.setItem("accordionOrder", JSON.stringify(accordionOrder));
                }
            } else {
                localStorage.setItem("accordionOrder", JSON.stringify(accordionOrder));
            }
        }

        function loadFromSQLite() {
            if (!db || !sqliteReady) {
                return { 
                    minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
                    favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
                    tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}"),
                    accordionOrder: JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]')
                };
            }
            
            try {
                const tarefasStmt = db.prepare("SELECT * FROM minhas_tarefas ORDER BY ordem ASC");
                const favoritosStmt = db.prepare("SELECT * FROM favoritos");
                const tarefasPorPessoaStmt = db.prepare("SELECT * FROM tarefas_por_pessoa");
                const orderStmt = db.prepare("SELECT * FROM accordion_order ORDER BY position");
                
                const minhasTarefas = [];
                while (tarefasStmt.step()) {
                    const row = tarefasStmt.getAsObject();
                    minhasTarefas.push({
                        id: row.id,
                        titulo: row.titulo,
                        descricao: row.descricao,
                        concluida: row.concluida === 1,
                        dataCreacao: row.data_criacao,
                        ordem: row.ordem || 0
                    });
                }
                
                const favoritos = [];
                while (favoritosStmt.step()) {
                    const row = favoritosStmt.getAsObject();
                    favoritos.push({
                        pessoa: row.pessoa,
                        tarefa: row.tarefa
                    });
                }
                
                const tarefasPorPessoa = {};
                while (tarefasPorPessoaStmt.step()) {
                    const row = tarefasPorPessoaStmt.getAsObject();
                    if (!tarefasPorPessoa[row.pessoa]) {
                        tarefasPorPessoa[row.pessoa] = [];
                    }
                    tarefasPorPessoa[row.pessoa].push(row.tarefa);
                }
                
                const accordionOrder = [];
                while (orderStmt.step()) {
                    const row = orderStmt.getAsObject();
                    accordionOrder.push(row.accordion_id);
                }
                
                // Se n√£o h√° ordem salva, usar padr√£o
                if (accordionOrder.length === 0) {
                    accordionOrder.push('minhas-tarefas', 'lista-favoritos');
                }
                
                tarefasStmt.free();
                favoritosStmt.free();
                tarefasPorPessoaStmt.free();
                orderStmt.free();
                
                return { minhasTarefas, favoritos, tarefasPorPessoa, accordionOrder };
            } catch (error) {
                console.error('Erro ao carregar do SQLite:', error);
                return { 
                    minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
                    favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
                    tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}"),
                    accordionOrder: JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]')
                };
            }
        }

        function saveFavoritos() {
            if (db && sqliteReady) {
                try {
                    db.run("DELETE FROM favoritos");
                    favoritos.forEach(fav => {
                        db.run("INSERT INTO favoritos (pessoa, tarefa) VALUES (?, ?)", [fav.pessoa, fav.tarefa]);
                    });
                    saveDatabase();
                } catch (error) {
                    console.error('Erro ao salvar favoritos no SQLite:', error);
                    localStorage.setItem("favoritos", JSON.stringify(favoritos));
                }
            } else {
                localStorage.setItem("favoritos", JSON.stringify(favoritos));
            }
        }

        function saveMinhasTarefas() {
            if (db && sqliteReady) {
                try {
                    db.run("DELETE FROM minhas_tarefas");
                    minhasTarefas.forEach((tarefa, index) => {
                        db.run("INSERT INTO minhas_tarefas (id, titulo, descricao, concluida, data_criacao, ordem) VALUES (?, ?, ?, ?, ?, ?)", 
                            [tarefa.id, tarefa.titulo, tarefa.descricao, tarefa.concluida ? 1 : 0, tarefa.dataCreacao, index]);
                    });
                    saveDatabase();
                } catch (error) {
                    console.error('Erro ao salvar tarefas no SQLite:', error);
                    localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
                }
            } else {
                localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
            }
        }

        function adicionarTarefa(titulo, descricao) {
            const novaTarefa = {
                id: Date.now(),
                titulo: titulo,
                descricao: descricao,
                concluida: false,
                dataCreacao: new Date().toLocaleDateString("pt-BR"),
                ordem: minhasTarefas.length
            };
            minhasTarefas.push(novaTarefa);
            saveMinhasTarefas();
            renderAccordion(document.getElementById("search").value.toLowerCase());
        }

        function editarTarefa(id, novoTitulo, novaDescricao) {
            const tarefa = minhasTarefas.find((t) => t.id === id);
            if (tarefa) {
                tarefa.titulo = novoTitulo;
                tarefa.descricao = novaDescricao;
                saveMinhasTarefas();
                renderAccordion(document.getElementById("search").value.toLowerCase());
            }
        }

        function excluirTarefa(id) {
            if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
                minhasTarefas = minhasTarefas.filter((t) => t.id !== id);
                // Reordenar
                minhasTarefas.forEach((tarefa, index) => {
                    tarefa.ordem = index;
                });
                saveMinhasTarefas();
                renderAccordion(document.getElementById("search").value.toLowerCase());
            }
        }

        function toggleConcluida(id) {
            const tarefa = minhasTarefas.find((t) => t.id === id);
            if (tarefa) {
                tarefa.concluida = !tarefa.concluida;
                saveMinhasTarefas();
                renderAccordion(document.getElementById("search").value.toLowerCase());
            }
        }

        function editAccordionTitle(accordionId) {
            const titleSpan = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title span`);
            const titleInput = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title input`);
            
            if (titleSpan && titleInput) {
                titleSpan.style.display = 'none';
                titleInput.style.display = 'block';
                titleInput.value = titleSpan.textContent;
                titleInput.focus();
                titleInput.select();
            }
        }

        function saveAccordionTitle(accordionId, newTitle) {
            if (newTitle.trim() && newTitle !== accordionId) {
                renameAccordion(accordionId, newTitle.trim());
            } else {
                // Cancelar edi√ß√£o
                const titleSpan = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title span`);
                const titleInput = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title input`);
                
                if (titleSpan && titleInput) {
                    titleInput.style.display = 'none';
                    titleSpan.style.display = 'block';
                }
            }
        }

        function renameAccordion(oldName, newName) {
            if (tarefasPorPessoa[oldName]) {
                tarefasPorPessoa[newName] = tarefasPorPessoa[oldName];
                delete tarefasPorPessoa[oldName];
                
                // Atualizar favoritos
                favoritos.forEach(fav => {
                    if (fav.pessoa === oldName) {
                        fav.pessoa = newName;
                    }
                });
                
                // Atualizar ordem dos acorde√µes
                const index = accordionOrder.indexOf(oldName);
                if (index !== -1) {
                    accordionOrder[index] = newName;
                }
                
                saveTarefasPorPessoa();
                saveFavoritos();
                saveAccordionOrder();
                renderAccordion(document.getElementById("search").value.toLowerCase());
            }
        }

        // Drag and Drop para acorde√µes
        function handleAccordionDragStart(e) {
            draggedElement = e.target.closest('.accordion');
            draggedType = 'accordion';
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        }

        function handleAccordionDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
                draggedType = null;
            }
            // Remover todos os indicadores
            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
        }

        function handleAccordionDragOver(e) {
            e.preventDefault();
            if (draggedType !== 'accordion') return;
            
            const targetAccordion = e.target.closest('.accordion');
            if (!targetAccordion || targetAccordion === draggedElement) return;
            
            // Remover indicadores anteriores
            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            
            // Determinar posi√ß√£o (acima ou abaixo)
            const rect = targetAccordion.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isAbove = e.clientY < midY;
            
            // Mostrar indicador
            const indicator = isAbove ? 
                targetAccordion.querySelector('.drop-indicator-top') :
                targetAccordion.querySelector('.drop-indicator-bottom');
            
            if (indicator) {
                indicator.classList.add('active');
            }
        }

        function handleAccordionDrop(e) {
            e.preventDefault();
            if (draggedType !== 'accordion') return;
            
            const targetAccordion = e.target.closest('.accordion');
            if (!targetAccordion || targetAccordion === draggedElement) return;
            
            const draggedId = draggedElement.getAttribute('data-accordion-id');
            const targetId = targetAccordion.getAttribute('data-accordion-id');
            
            // Determinar posi√ß√£o
            const rect = targetAccordion.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isAbove = e.clientY < midY;
            
            const draggedIndex = accordionOrder.indexOf(draggedId);
            const targetIndex = accordionOrder.indexOf(targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                accordionOrder.splice(draggedIndex, 1);
                const newIndex = isAbove ? targetIndex : targetIndex + 1;
                accordionOrder.splice(newIndex, 0, draggedId);
                saveAccordionOrder();
                renderAccordion(document.getElementById("search").value.toLowerCase());
            }
        }

        // Fun√ß√µes Drag and Drop para tarefas
        function handleTaskDragStart(e) {
            draggedElement = e.target.closest('.task-item');
            draggedType = 'task';
            draggedIndex = [...draggedElement.parentNode.children].indexOf(draggedElement);
            
            // Armazena o ID da se√ß√£o de origem
            draggedSource = draggedElement.getAttribute('data-source');
            
            draggedElement.classList.add('dragging');
            e.dataTransfer.setData('text/plain', draggedElement.dataset.taskId);
            e.dataTransfer.effectAllowed = 'move';
            
            // Mostra o indicador de arraste
            setTimeout(() => {
                draggedElement.style.opacity = '0.4';
            }, 0);
        }

        function handleTaskDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedType !== 'task') return;
            
            const targetTask = e.target.closest('.task-item');
            if (!targetTask || targetTask === draggedElement) return;
            
            // Permitir drop explicitamente
            e.dataTransfer.dropEffect = 'move';
            
            // Remove indicadores anteriores
            document.querySelectorAll('.task-drop-indicator').forEach(ind => ind.classList.remove('active'));
            
            // Calcula posi√ß√£o relativa
            const rect = targetTask.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isBefore = e.clientY < midY;
            
            // Mostra o indicador apropriado
            const indicator = isBefore 
                ? targetTask.querySelector('.task-drop-indicator-top')
                : targetTask.querySelector('.task-drop-indicator-bottom');
            
            if (indicator) {
                indicator.classList.add('active');
            }
        }

        function handleTaskDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedType !== 'task') return;
            
            const targetTask = e.target.closest('.task-item');
            if (!targetTask || targetTask === draggedElement) return;
            
            // Determina a posi√ß√£o de inser√ß√£o
            const rect = targetTask.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isBefore = e.clientY < midY;
            
            // Remove indicadores
            document.querySelectorAll('.task-drop-indicator').forEach(ind => ind.classList.remove('active'));
            
            // L√≥gica de reordena√ß√£o
            const targetSource = targetTask.getAttribute('data-source');
            const taskId = draggedElement.getAttribute('data-task-id');
            
            if (draggedSource === targetSource) {
                // Reordena√ß√£o dentro da mesma se√ß√£o
                handleTaskReorderWithinSection(taskId, targetTask, isBefore, draggedSource);
            } else {
                // Mover entre se√ß√µes diferentes
                handleTaskDropBetweenSections(taskId, draggedSource, targetSource);
            }
            
            // Restaura a apar√™ncia do elemento arrastado
            draggedElement.style.opacity = '1';
            draggedElement.classList.remove('dragging');
        }

        function handleTaskReorderWithinSection(taskId, targetTask, isBefore, source) {
            if (source === 'minhas-tarefas') {
                // Reordena√ß√£o em "Minhas Tarefas"
                const oldIndex = minhasTarefas.findIndex(t => t.id == taskId);
                const task = minhasTarefas[oldIndex];
                
                if (task) {
                    const targetIndex = minhasTarefas.findIndex(t => t.id == targetTask.dataset.taskId);
                    let newIndex = isBefore ? targetIndex : targetIndex + 1;
                    
                    // Ajustar √≠ndice se estiver movendo para baixo
                    if (oldIndex < targetIndex && !isBefore) {
                        newIndex = targetIndex;
                    } else if (oldIndex > targetIndex && isBefore) {
                        newIndex = targetIndex;
                    }
                    
                    // Remove da posi√ß√£o antiga
                    minhasTarefas.splice(oldIndex, 1);
                    // Insere na nova posi√ß√£o
                    minhasTarefas.splice(newIndex, 0, task);
                    
                    // Atualiza ordens
                    minhasTarefas.forEach((t, i) => t.ordem = i);
                    
                    saveMinhasTarefas();
                    renderAccordion(document.getElementById("search").value.toLowerCase());
                    showStatus('Tarefa reordenada com sucesso!');
                }
            } else if (source === 'lista-favoritos') {
                // Reordena√ß√£o em "Lista de Favoritos"
                const oldIndex = favoritos.findIndex(f => f.tarefa === taskId);
                const fav = favoritos[oldIndex];
                
                if (fav) {
                    const targetIndex = favoritos.findIndex(f => f.tarefa === targetTask.dataset.taskId);
                    let newIndex = isBefore ? targetIndex : targetIndex + 1;
                    
                    // Ajustar √≠ndice se estiver movendo para baixo
                    if (oldIndex < targetIndex && !isBefore) {
                        newIndex = targetIndex;
                    } else if (oldIndex > targetIndex && isBefore) {
                        newIndex = targetIndex;
                    }
                    
                    // Remove da posi√ß√£o antiga
                    favoritos.splice(oldIndex, 1);
                    // Insere na nova posi√ß√£o
                    favoritos.splice(newIndex, 0, fav);
                    
                    saveFavoritos();
                    renderAccordion(document.getElementById("search").value.toLowerCase());
                    showStatus('Favorito reordenado com sucesso!');
                }
            } else {
                // Reordena√ß√£o em tarefas importadas
                if (tarefasPorPessoa[source]) {
                    const oldIndex = tarefasPorPessoa[source].findIndex(t => t === taskId);
                    const task = tarefasPorPessoa[source][oldIndex];
                    
                    if (task) {
                        const targetIndex = tarefasPorPessoa[source].findIndex(t => t === targetTask.dataset.taskId);
                        let newIndex = isBefore ? targetIndex : targetIndex + 1;
                        
                        // Ajustar √≠ndice se estiver movendo para baixo
                        if (oldIndex < targetIndex && !isBefore) {
                            newIndex = targetIndex;
                        } else if (oldIndex > targetIndex && isBefore) {
                            newIndex = targetIndex;
                        }
                        
                        // Remove da posi√ß√£o antiga
                        tarefasPorPessoa[source].splice(oldIndex, 1);
                        // Insere na nova posi√ß√£o
                        tarefasPorPessoa[source].splice(newIndex, 0, task);
                        
                        saveTarefasPorPessoa();
                        renderAccordion(document.getElementById("search").value.toLowerCase());
                        showStatus('Tarefa importada reordenada com sucesso!');
                    }
                }
            }
        }

        function handleTaskDropBetweenSections(taskId, source, target) {
            try {
                if (source === 'minhas-tarefas' && target !== 'minhas-tarefas') {
                    // Mover de Minhas Tarefas para outro acorde√£o
                    const tarefa = minhasTarefas.find(t => t.id == taskId);
                    if (tarefa) {
                        if (target === 'lista-favoritos') {
                            favoritos.push({pessoa: 'Minhas Tarefas', tarefa: tarefa.titulo});
                            saveFavoritos();
                        } else {
                            if (!tarefasPorPessoa[target]) {
                                tarefasPorPessoa[target] = [];
                            }
                            tarefasPorPessoa[target].push(tarefa.titulo);
                            saveTarefasPorPessoa();
                        }
                        minhasTarefas = minhasTarefas.filter(t => t.id != taskId);
                        // Reordenar
                        minhasTarefas.forEach((tarefa, index) => {
                            tarefa.ordem = index;
                        });
                        saveMinhasTarefas();
                    }
                } else if (source !== 'minhas-tarefas' && target === 'minhas-tarefas') {
                    // Mover de outro acorde√£o para Minhas Tarefas
                    let tarefaTexto = '';
                    
                    if (source === 'lista-favoritos') {
                        const fav = favoritos.find(f => f.tarefa === taskId);
                        if (fav) {
                            tarefaTexto = fav.tarefa;
                            favoritos = favoritos.filter(f => f.tarefa !== taskId);
                            saveFavoritos();
                        }
                    } else {
                        if (tarefasPorPessoa[source]) {
                            const index = tarefasPorPessoa[source].indexOf(taskId);
                            if (index !== -1) {
                                tarefaTexto = taskId;
                                tarefasPorPessoa[source].splice(index, 1);
                                saveTarefasPorPessoa();
                            }
                        }
                    }
                    
                    if (tarefaTexto) {
                        adicionarTarefa(tarefaTexto, `Movida de ${source}`);
                    }
                }
                
                renderAccordion(document.getElementById("search").value.toLowerCase());
                showStatus('Tarefa movida com sucesso!');
            } catch (error) {
                console.error('Erro ao mover tarefa:', error);
                showStatus('Erro ao mover tarefa', true);
            }
        }

        function handleTaskDragEnd() {
            if (draggedElement) {
                draggedElement.style.opacity = '1';
                draggedElement.classList.remove('dragging');
            }
            document.querySelectorAll('.task-drop-indicator').forEach(ind => ind.classList.remove('active'));
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('active', 'hover');
            });
            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            draggedElement = null;
            draggedType = null;
            draggedIndex = -1;
            draggedSource = null;
        }

        function handleDropZoneDragOver(e) {
            e.preventDefault();
            e.target.classList.add('hover');
        }

        function handleTaskDropZone(e, targetAccordion) {
            e.preventDefault();
            e.target.classList.remove('hover');
            
            if (draggedType !== 'task') return;
            
            try {
                const taskId = draggedElement.getAttribute('data-task-id');
                const source = draggedElement.getAttribute('data-source');
                
                handleTaskDropBetweenSections(taskId, source, targetAccordion);
            } catch (error) {
                console.error('Erro ao mover tarefa:', error);
                showStatus('Erro ao mover tarefa', true);
            }
        }

        // Fun√ß√£o para criar tarefa importada
        function createImportedTask(pessoa, tarefa, accordionId) {
            const li = document.createElement("div");
            li.className = "task-item imported-task";
            li.setAttribute('data-task-id', tarefa);
            li.setAttribute('data-source', accordionId);
            li.draggable = false; // O drag ser√° feito pelo handle

            const isFavorito = favoritos.some(f => f.pessoa === pessoa && f.tarefa === tarefa);
            
            li.innerHTML = `
                <div class="task-drop-indicator task-drop-indicator-top"></div>
                <div class="task-content">
                    <div class="task-drag-handle" draggable="true">‚ãÆ‚ãÆ</div>
                    <div class="task-info">
                        <div class="task-title">${tarefa}</div>
                        <div class="task-source">De: ${pessoa}</div>
                    </div>
                    <div class="task-actions">
                        <button class="task-menu-button">‚ãÆ</button>
                        <div class="task-action-buttons" id="actions-${accordionId}-${tarefa.replace(/\s+/g, '-')}">
                            <button class="task-action-btn btn-favorite" title="${isFavorito ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                ${isFavorito ? '‚≠ê' : '‚òÜ'}
                            </button>
                            <button class="task-action-btn btn-delete" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="task-drop-indicator task-drop-indicator-bottom"></div>
            `;
            
            // Eventos de drag corrigidos
            const dragHandle = li.querySelector('.task-drag-handle');
            dragHandle.addEventListener('dragstart', handleTaskDragStart);
            dragHandle.addEventListener('dragend', handleTaskDragEnd);
            
            // Eventos de drop no elemento li
            li.addEventListener('dragover', handleTaskDragOver);
            li.addEventListener('drop', handleTaskDrop);
            
            // Eventos dos bot√µes
            const menuBtn = li.querySelector('.task-menu-button');
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                const buttons = li.querySelector('.task-action-buttons');
                buttons.classList.toggle('show');
            };

            li.querySelector('.btn-favorite').onclick = (e) => {
                e.stopPropagation();
                toggleFavorite(pessoa, tarefa, accordionId);
            };

            li.querySelector('.btn-delete').onclick = (e) => {
                e.stopPropagation();
                removeTask(pessoa, tarefa);
            };

            return li;
        }

        // Fun√ß√£o para criar estrela de favoritos
        function createStar(pessoa, tarefa) {
            const star = document.createElement("span");
            star.className = "star";
            star.innerHTML = "‚≠ê";
            if (favoritos.some(f => f.pessoa === pessoa && f.tarefa === tarefa)) {
                star.classList.add("favorited");
            }
            star.onclick = function () {
                toggleFavorite(pessoa, tarefa);
            };
            return star;
        }

        // Fun√ß√£o para criar √≠cone de confirma√ß√£o
        function createConfirmIcon(pessoa, tarefa) {
            const confirmIcon = document.createElement("span");
            confirmIcon.className = "confirm-icon";
            confirmIcon.innerHTML = "‚úîÔ∏è";
            confirmIcon.onclick = function () {
                favoritos = favoritos.filter(f => !(f.pessoa === pessoa && f.tarefa === tarefa));
                saveFavoritos();
                adicionarTarefa(tarefa, `Tarefa importada de ${pessoa}`);
                renderAccordion(document.getElementById("search").value.toLowerCase());
            };
            return confirmIcon;
        }

        // Fun√ß√£o para criar √≠cone de lixeira
        function createTrashIcon(pessoa, tarefa) {
            const trash = document.createElement("span");
            trash.className = "trash-icon";
            trash.innerHTML = "üóëÔ∏è";
            trash.onclick = function () {
                if (confirm(`Remover "${tarefa}" da lista de ${pessoa}?`)) {
                    favoritos = favoritos.filter(f => !(f.pessoa === pessoa && f.tarefa === tarefa));
                    saveFavoritos();
                    renderAccordion(document.getElementById("search").value.toLowerCase());
                }
            };
            return trash;
        }

        function createMinhasTarefasAccordion(filtro = "") {
            const filteredMinhasTarefas = minhasTarefas.filter(
                (t) =>
                    t.titulo.toLowerCase().includes(filtro) ||
                    t.descricao.toLowerCase().includes(filtro)
            );

            if (filtro && filteredMinhasTarefas.length === 0) {
                return null;
            }

            const acc = document.createElement("div");
            acc.className = "accordion";
            acc.setAttribute('data-accordion-id', 'minhas-tarefas');

            // Indicadores de drop para acorde√£o
            const dropIndicatorTop = document.createElement("div");
            dropIndicatorTop.className = "drop-indicator drop-indicator-top";
            
            const dropIndicatorBottom = document.createElement("div");
            dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

            const header = document.createElement("div");
            header.className = "accordion-header";
            
            const headerContent = document.createElement("div");
            headerContent.className = "accordion-header-content";
            
            const title = document.createElement("div");
            title.className = "accordion-title";
            title.innerHTML = `<span>Minhas Tarefas (${filteredMinhasTarefas.length})</span>`;
            
            const newTaskBtn = document.createElement("button");
            newTaskBtn.className = "new-task-button";
            newTaskBtn.textContent = "+ Nova Tarefa";
            newTaskBtn.onclick = openTaskModal;
            
            headerContent.appendChild(title);
            header.appendChild(headerContent);
            header.appendChild(newTaskBtn);
            
            const isOpen = getAccordionState('minhas-tarefas');
            header.onclick = function (e) {
                if (e.target.tagName !== "BUTTON") {
                    const content = this.nextElementSibling;
                    const newState = content.style.display !== "block";
                    content.style.display = newState ? "block" : "none";
                    saveAccordionState('minhas-tarefas', newState);
                }
            };

            const content = document.createElement("div");
            content.className = "accordion-content";
            content.style.display = isOpen ? "block" : "none";

            const dropZone = document.createElement("div");
            dropZone.className = "drop-zone";
            dropZone.innerHTML = "Solte tarefas aqui para mover para Minhas Tarefas";
            dropZone.addEventListener('dragover', handleDropZoneDragOver);
            dropZone.addEventListener('drop', (e) => handleTaskDropZone(e, 'minhas-tarefas'));

            const ul = document.createElement("ul");

            // Ordenar tarefas por ordem
            filteredMinhasTarefas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

            filteredMinhasTarefas.forEach((tarefa) => {
                const li = document.createElement("li");
                li.className = "task-item";
                if (tarefa.concluida) {
                    li.classList.add('task-completed');
                }
                li.setAttribute('data-task-id', tarefa.id);
                li.setAttribute('data-source', 'minhas-tarefas');

                // Indicadores de drop para tarefa
                const taskDropIndicatorTop = document.createElement("div");
                taskDropIndicatorTop.className = "task-drop-indicator task-drop-indicator-top";
                
                const taskDropIndicatorBottom = document.createElement("div");
                taskDropIndicatorBottom.className = "task-drop-indicator task-drop-indicator-bottom";

                const dragHandle = document.createElement("div");
                dragHandle.className = "task-drag-handle";
                dragHandle.innerHTML = "‚ãÆ‚ãÆ";
                dragHandle.draggable = true;
                dragHandle.addEventListener('dragstart', handleTaskDragStart);
                dragHandle.addEventListener('dragend', handleTaskDragEnd);

                const taskContent = document.createElement("div");
                taskContent.className = "task-content";
                
                const taskInfo = document.createElement("div");
                taskInfo.className = "task-info";
                
                // Destacar texto da pesquisa
                const titulo = highlightSearchText(tarefa.titulo, filtro);
                const descricao = tarefa.descricao ? highlightSearchText(tarefa.descricao, filtro) : "";
                
                taskInfo.innerHTML = `
                    <div class="task-title">${titulo}</div>
                    ${descricao ? `<div class="task-description">${descricao}</div>` : ""}
                    <div class="task-date">Criada em: ${tarefa.dataCreacao}</div>
                `;

                const actions = document.createElement("div");
                actions.className = "task-actions";
                
                const menuButton = document.createElement("button");
                menuButton.className = "task-menu-button";
                menuButton.innerHTML = "‚ãÆ";
                menuButton.onclick = (e) => {
                    e.stopPropagation();
                    toggleTaskActions(tarefa.id);
                };
                
                const actionButtons = document.createElement("div");
                actionButtons.className = "task-action-buttons";
                actionButtons.id = `actions-${tarefa.id}`;
                actionButtons.innerHTML = `
                    <button class="task-action-btn btn-complete" onclick="toggleConcluida(${tarefa.id})" title="${tarefa.concluida ? 'Reabrir' : 'Concluir'}">
                        ${tarefa.concluida ? '‚Ü©Ô∏è' : '‚úÖ'}
                    </button>
                    <button class="task-action-btn btn-edit" onclick="editarTarefaForm(${tarefa.id})" title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <button class="task-action-btn btn-delete" onclick="excluirTarefa(${tarefa.id})" title="Excluir">
                        üóëÔ∏è
                    </button>
                `;

                const editForm = document.createElement("div");
                editForm.className = "edit-form";
                editForm.id = `edit-form-${tarefa.id}`;
                editForm.innerHTML = `
                    <input type="text" id="edit-title-${tarefa.id}" value="${tarefa.titulo}" placeholder="T√≠tulo">
                    <input type="text" id="edit-desc-${tarefa.id}" value="${tarefa.descricao || ""}" placeholder="Descri√ß√£o">
                    <div class="form-buttons">
                        <button class="modal-btn modal-btn-primary" onclick="salvarEdicao(${tarefa.id})">Salvar</button>
                        <button class="modal-btn modal-btn-secondary" onclick="cancelarEdicao(${tarefa.id})">Cancelar</button>
                    </div>
                `;

                taskContent.appendChild(dragHandle);
                taskContent.appendChild(taskInfo);
                actions.appendChild(menuButton);
                actions.appendChild(actionButtons);
                taskContent.appendChild(actions);
                
                li.appendChild(taskDropIndicatorTop);
                li.appendChild(taskContent);
                li.appendChild(editForm);
                li.appendChild(taskDropIndicatorBottom);
                
                li.addEventListener('dragover', handleTaskDragOver);
                li.addEventListener('drop', handleTaskDrop);
                ul.appendChild(li);
            });

            content.appendChild(dropZone);
            content.appendChild(ul);
            
            acc.appendChild(dropIndicatorTop);
            acc.appendChild(header);
            acc.appendChild(content);
            acc.appendChild(dropIndicatorBottom);

            acc.addEventListener('dragover', handleAccordionDragOver);
            acc.addEventListener('drop', handleAccordionDrop);

            return acc;
        }

        // Fun√ß√£o para destacar texto da pesquisa
        function highlightSearchText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        function editarTarefaForm(id) {
            const tarefa = minhasTarefas.find(t => t.id === id);
            if (tarefa) {
                editandoTarefa = tarefa;
                document.getElementById('taskTitle').value = tarefa.titulo;
                document.getElementById('taskDescription').value = tarefa.descricao || '';
                openTaskModal();
            }
        }

        function salvarEdicao(id) {
            const novoTitulo = document.getElementById(`edit-title-${id}`).value.trim();
            const novaDescricao = document.getElementById(`edit-desc-${id}`).value.trim();

            if (!novoTitulo) {
                alert("Por favor, insira um t√≠tulo para a tarefa.");
                return;
            }

            editarTarefa(id, novoTitulo, novaDescricao);
            document.getElementById(`edit-form-${id}`).style.display = "none";
        }

        function cancelarEdicao(id) {
            const tarefa = minhasTarefas.find((t) => t.id === id);
            if (tarefa) {
                document.getElementById(`edit-title-${id}`).value = tarefa.titulo;
                document.getElementById(`edit-desc-${id}`).value = tarefa.descricao || "";
            }
            document.getElementById(`edit-form-${id}`).style.display = "none";
        }

        function renderAccordion(filtro = "") {
            const container = document.getElementById("accordion-container");
            container.innerHTML = "";

            // Renderizar acorde√µes na ordem salva
            accordionOrder.forEach(accordionId => {
                if (accordionId === 'minhas-tarefas') {
                    const minhasTarefasAccordion = createMinhasTarefasAccordion(filtro);
                    if (minhasTarefasAccordion) {
                        container.appendChild(minhasTarefasAccordion);
                    }
                } else if (accordionId === 'lista-favoritos') {
                    const favoritosFiltrados = favoritos.filter(
                        (f) =>
                            f.tarefa.toLowerCase().includes(filtro) ||
                            f.pessoa.toLowerCase().includes(filtro)
                    );
                    if (favoritosFiltrados.length > 0 || !filtro) {
                        const acc = document.createElement("div");
                        acc.className = "accordion";
                        acc.setAttribute('data-accordion-id', 'lista-favoritos');
                        
                        // Indicadores de drop

                        const dropIndicatorTop = document.createElement("div");
                        dropIndicatorTop.className = "drop-indicator drop-indicator-top";
                        
                        const dropIndicatorBottom = document.createElement("div");
                        dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";
                        
                        const header = document.createElement("div");
                        header.className = "accordion-header";
                        
                        const headerContent = document.createElement("div");
                        headerContent.className = "accordion-header-content";
                        
                        const title = document.createElement("div");
                        title.className = "accordion-title";
                        title.innerHTML = `<span>Lista de Favoritos (${favoritosFiltrados.length})</span>`;
                        
                        headerContent.appendChild(title);
                        header.appendChild(headerContent);
                        
                        const isOpen = getAccordionState('lista-favoritos');
                        header.onclick = function (e) {
                            if (e.target.tagName !== "BUTTON") {
                                const content = this.nextElementSibling;
                                const newState = content.style.display !== "block";
                                content.style.display = newState ? "block" : "none";
                                saveAccordionState('lista-favoritos', newState);
                            }
                        };
                        
                        const content = document.createElement("div");
                        content.className = "accordion-content";
                        content.style.display = isOpen ? "block" : "none";
                        
                        const dropZone = document.createElement("div");
                        dropZone.className = "drop-zone";
                        dropZone.innerHTML = "Solte tarefas aqui para adicionar aos favoritos";
                        dropZone.addEventListener('dragover', handleDropZoneDragOver);
                        dropZone.addEventListener('drop', (e) => handleTaskDropZone(e, 'lista-favoritos'));
                        
                        const ul = document.createElement("ul");
                        favoritosFiltrados.forEach(({ pessoa, tarefa }) => {
                            const li = document.createElement("li");
                            li.className = "task-item";
                            li.setAttribute('data-task-id', tarefa);
                            li.setAttribute('data-source', 'lista-favoritos');
                            
                            // Indicadores de drop para tarefa
                            const taskDropIndicatorTop = document.createElement("div");
                            taskDropIndicatorTop.className = "task-drop-indicator task-drop-indicator-top";
                            
                            const taskDropIndicatorBottom = document.createElement("div");
                            taskDropIndicatorBottom.className = "task-drop-indicator task-drop-indicator-bottom";

                            const dragHandle = document.createElement("div");
                            dragHandle.className = "task-drag-handle";
                            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
                            dragHandle.draggable = true;
                            dragHandle.addEventListener('dragstart', handleTaskDragStart);
                            dragHandle.addEventListener('dragend', handleTaskDragEnd);
                            
                            const taskContent = document.createElement("div");
                            taskContent.className = "task-content";
                            
                            const taskInfo = document.createElement("div");
                            taskInfo.className = "task-info";
                            
                            // Destacar texto da pesquisa
                            const titulo = highlightSearchText(tarefa, filtro);
                            const pessoaText = highlightSearchText(pessoa, filtro);
                            
                            taskInfo.innerHTML = `
                                <div class="task-title">${titulo}</div>
                                <div class="task-description">De: ${pessoaText}</div>
                            `;
                            
                            const actions = document.createElement("div");
                            actions.className = "task-actions";
                            
                            const menuButton = document.createElement("button");
                            menuButton.className = "task-menu-button";
                            menuButton.innerHTML = "‚ãÆ";
                            menuButton.onclick = (e) => {
                                e.stopPropagation();
                                toggleTaskActions(`lista-favoritos-${tarefa.replace(/\s+/g, '-')}`);
                            };
                            
                            const actionButtons = document.createElement("div");
                            actionButtons.className = "task-action-buttons";
                            actionButtons.id = `actions-lista-favoritos-${tarefa.replace(/\s+/g, '-')}`;
                            actionButtons.innerHTML = `
                                <button class="task-action-btn btn-favorite" title="Remover dos favoritos" onclick="toggleFavorite('${pessoa}', '${tarefa}', 'lista-favoritos')">
                                    ‚≠ê
                                </button>
                                <button class="task-action-btn btn-delete" title="Excluir" onclick="removeTask('${pessoa}', '${tarefa}')">
                                    üóëÔ∏è
                                </button>
                            `;
                            
                            taskContent.appendChild(dragHandle);
                            taskContent.appendChild(taskInfo);
                            actions.appendChild(menuButton);
                            actions.appendChild(actionButtons);
                            taskContent.appendChild(actions);
                            
                            li.appendChild(taskDropIndicatorTop);
                            li.appendChild(taskContent);
                            li.appendChild(taskDropIndicatorBottom);
                            
                            li.addEventListener('dragover', handleTaskDragOver);
                            li.addEventListener('drop', handleTaskDrop);
                            ul.appendChild(li);
                        });
                        
                        content.appendChild(dropZone);
                        content.appendChild(ul);
                        
                        acc.appendChild(dropIndicatorTop);
                        acc.appendChild(header);
                        acc.appendChild(content);
                        acc.appendChild(dropIndicatorBottom);
                        
                        acc.addEventListener('dragover', handleAccordionDragOver);
                        acc.addEventListener('drop', handleAccordionDrop);
                        
                        container.appendChild(acc);
                    }
                } else if (tarefasPorPessoa[accordionId]) {
                    const tarefasFiltradas = tarefasPorPessoa[accordionId].filter(
                        (t) => t.toLowerCase().includes(filtro)
                    );
                    if (tarefasFiltradas.length > 0 || accordionId.toLowerCase().includes(filtro)) {
                        const acc = document.createElement("div");
                        acc.className = "accordion";
                        acc.setAttribute('data-accordion-id', accordionId);

                        // Indicadores de drop
                        const dropIndicatorTop = document.createElement("div");
                        dropIndicatorTop.className = "drop-indicator drop-indicator-top";
                        
                        const dropIndicatorBottom = document.createElement("div");
                        dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

                        const header = document.createElement("div");
                        header.className = "accordion-header";
                        
                        const headerContent = document.createElement("div");
                        headerContent.className = "accordion-header-content";
                        
                        const dragHandle = document.createElement("div");
                        dragHandle.className = "drag-handle";
                        dragHandle.innerHTML = "‚ãÆ‚ãÆ";
                        dragHandle.draggable = true;
                        dragHandle.addEventListener('dragstart', handleAccordionDragStart);
                        dragHandle.addEventListener('dragend', handleAccordionDragEnd);
                        
                        const title = document.createElement("div");
                        title.className = "accordion-title";
                        title.innerHTML = `
                            <span>${accordionId} (${tarefasFiltradas.length})</span>
                            <input type="text" value="${accordionId}" style="display: none;">
                        `;
                        
                        const editBtn = document.createElement("button");
                        editBtn.className = "edit-btn";
                        editBtn.innerHTML = "‚úé";
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            editAccordionTitle(accordionId);
                        };
                        
                        // Event listeners para o input
                        const titleInput = title.querySelector('input');
                        titleInput.addEventListener('blur', () => {
                            saveAccordionTitle(accordionId, titleInput.value);
                        });
                        titleInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                titleInput.blur();
                            }
                        });
                        
                        headerContent.appendChild(dragHandle);
                        headerContent.appendChild(title);
                        header.appendChild(headerContent);
                        header.appendChild(editBtn);
                        
                        const isOpen = getAccordionState(accordionId);
                        header.onclick = function (e) {
                            if (e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT" && !e.target.classList.contains('drag-handle')) {
                                const content = this.nextElementSibling;
                                const newState = content.style.display !== "block";
                                content.style.display = newState ? "block" : "none";
                                saveAccordionState(accordionId, newState);
                            }
                        };

                        const content = document.createElement("div");
                        content.className = "accordion-content";
                        content.style.display = isOpen ? "block" : "none";
                        
                        const dropZone = document.createElement("div");
                        dropZone.className = "drop-zone";
                        dropZone.innerHTML = `Solte tarefas aqui para mover para ${accordionId}`;
                        dropZone.addEventListener('dragover', handleDropZoneDragOver);
                        dropZone.addEventListener('drop', (e) => handleTaskDropZone(e, accordionId));
                        
                        const ul = document.createElement("ul");
                        tarefasFiltradas.forEach(tarefa => {
                            const taskElement = createImportedTask(accordionId, tarefa, accordionId);
                            ul.appendChild(taskElement);
                        });
                        
                        content.appendChild(dropZone);
                        content.appendChild(ul);

                        acc.appendChild(dropIndicatorTop);
                        acc.appendChild(header);
                        acc.appendChild(content);
                        acc.appendChild(dropIndicatorBottom);
                        
                        acc.addEventListener('dragover', handleAccordionDragOver);
                        acc.addEventListener('drop', handleAccordionDrop);
                        
                        container.appendChild(acc);
                    }
                }
            });

            // Adicionar acorde√µes que n√£o est√£o na ordem salva
            for (let pessoa in tarefasPorPessoa) {
                if (!accordionOrder.includes(pessoa)) {
                    accordionOrder.push(pessoa);
                    saveAccordionOrder();
                }
            }
        }

        function toggleFavorite(pessoa, tarefa, accordionId) {
            const existsIndex = favoritos.findIndex(f => f.pessoa === pessoa && f.tarefa === tarefa);
            
            if (existsIndex >= 0) {
                // Remove dos favoritos e retorna para o local de origem
                favoritos.splice(existsIndex, 1);
                saveFavoritos();
                
                // Se estava na lista de favoritos, retorna para o acorde√£o original
                if (accordionId === 'lista-favoritos') {
                    if (!tarefasPorPessoa[pessoa]) {
                        tarefasPorPessoa[pessoa] = [];
                    }
                    tarefasPorPessoa[pessoa].push(tarefa);
                    saveTarefasPorPessoa();
                }
            } else {
                // Adiciona aos favoritos e remove do local de origem
                favoritos.push({ pessoa, tarefa });
                saveFavoritos();
                
                // Remove do acorde√£o original se n√£o for "Minhas Tarefas"
                if (accordionId && accordionId !== 'minhas-tarefas' && tarefasPorPessoa[pessoa]) {
                    const taskIndex = tarefasPorPessoa[pessoa].indexOf(tarefa);
                    if (taskIndex !== -1) {
                        tarefasPorPessoa[pessoa].splice(taskIndex, 1);
                        saveTarefasPorPessoa();
                    }
                }
            }
            
            renderAccordion(document.getElementById("search").value.toLowerCase());
            showStatus(`Tarefa ${existsIndex >= 0 ? 'removida dos' : 'adicionada aos'} favoritos`);
        }

        function removeTask(pessoa, tarefa) {
            if (confirm(`Remover "${tarefa}" da lista de ${pessoa}?`)) {
                if (tarefasPorPessoa[pessoa]) {
                    tarefasPorPessoa[pessoa] = tarefasPorPessoa[pessoa].filter(t => t !== tarefa);
                    saveTarefasPorPessoa();
                }
                
                // Tamb√©m remove dos favoritos se estiver l√°
                const favIndex = favoritos.findIndex(f => f.pessoa === pessoa && f.tarefa === tarefa);
                if (favIndex >= 0) {
                    favoritos.splice(favIndex, 1);
                    saveFavoritos();
                }
                
                renderAccordion();
                showStatus('Tarefa removida com sucesso');
            }
        }

        function exportFavoritosJSON() {
            const exportData = {
                favoritos: favoritos,
                minhasTarefas: minhasTarefas,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "favoritos_e_minhas_tarefas.json";
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Favoritos e Minhas Tarefas exportados!');
            closeSidebar();
        }

        function exportFavoritosCSV() {
            // Usar BOM UTF-8 para garantir acentua√ß√£o correta
            let csv = "\uFEFF";
            csv += "Respons√°vel,Tarefa\n";
            favoritos.forEach(({ pessoa, tarefa }) => {
                // Escapar aspas duplas e envolver em aspas
                const pessoaEscapada = `"${pessoa.replace(/"/g, '""')}"`;
                const tarefaEscapada = `"${tarefa.replace(/"/g, '""')}"`;
                csv += `${pessoaEscapada},${tarefaEscapada}\n`;
            });
            
            const blob = new Blob([csv], { 
                type: "text/csv;charset=utf-8;" 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "favoritos.csv";
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Favoritos exportados em CSV!');
            closeSidebar();
        }

        function exportDatabase() {
            saveTarefasPorPessoa();
            saveAccordionOrder();
            
            if (db && sqliteReady) {
                try {
                    const data = db.export();
                    const blob = new Blob([data], { type: "application/x-sqlite3" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "tarefas_segunda_backup.sqlite";
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showStatus('Backup SQLite criado com sucesso!');
                } catch (error) {
                    console.error('Erro ao exportar banco:', error);
                    showStatus('Erro ao criar backup SQLite', true);
                }
            } else {
                showStatus("SQLite n√£o dispon√≠vel. Criando backup JSON...", true);
                const backup = {
                    minhasTarefas: minhasTarefas,
                    favoritos: favoritos,
                    tarefasPorPessoa: tarefasPorPessoa,
                    accordionOrder: accordionOrder,
                    timestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tarefas_segunda_backup.json';
                a.click();
                URL.revokeObjectURL(url);
            }
            closeSidebar();
        }

        async function importDatabase() {
            const input = document.getElementById('restore');
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            if (file.name.endsWith('.sqlite')) {
                                if (!sqliteReady) {
                                    showStatus('Inicializando SQLite...', false);
                                    await initSQLite();
                                }
                                
                                if (sqliteReady && SQL) {
                                    try {
                                        const uint8Array = new Uint8Array(e.target.result);
                                        db = new SQL.Database(uint8Array);
                                        const data = loadFromSQLite();
                                        minhasTarefas = data.minhasTarefas;
                                        favoritos = data.favoritos;
                                        tarefasPorPessoa = data.tarefasPorPessoa;
                                        accordionOrder = data.accordionOrder;
                                        renderAccordion();
                                        showStatus('Banco SQLite restaurado com sucesso!');
                                    } catch (sqlError) {
                                        console.error('Erro ao processar arquivo SQLite:', sqlError);
                                        showStatus('Erro: Arquivo SQLite inv√°lido ou corrompido', true);
                                    }
                                } else {
                                    showStatus('Erro: SQLite n√£o est√° dispon√≠vel', true);
                                }
                            } else if (file.name.endsWith('.json')) {
                                try {
                                    const backup = JSON.parse(e.target.result);
                                    minhasTarefas = backup.minhasTarefas || [];
                                    favoritos = backup.favoritos || [];
                                    tarefasPorPessoa = backup.tarefasPorPessoa || {};
                                    accordionOrder = backup.accordionOrder || ['minhas-tarefas', 'lista-favoritos'];
                                    saveMinhasTarefas();
                                    saveFavoritos();
                                    saveTarefasPorPessoa();
                                    saveAccordionOrder();
                                    renderAccordion();
                                    showStatus('Backup JSON restaurado com sucesso!');
                                } catch (jsonError) {
                                    console.error('Erro ao processar arquivo JSON:', jsonError);
                                    showStatus('Erro: Arquivo JSON inv√°lido', true);
                                }
                            }
                        } catch (error) {
                            console.error('Erro geral ao restaurar backup:', error);
                            showStatus('Erro ao restaurar backup: ' + error.message, true);
                        }
                    };
                    
                    if (file.name.endsWith('.sqlite')) {
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.readAsText(file);
                    }
                }
            };
            input.click();
        }

        function clearWordData() {
            if (confirm("Tem certeza que deseja limpar todos os dados carregados do Word? Esta a√ß√£o n√£o pode ser desfeita.\n\nOs dados de 'Minhas Tarefas' e 'Lista de Favoritos' ser√£o preservados.")) {
                // Limpar dados do Word
                tarefasPorPessoa = {};
                
                // Resetar ordem dos acorde√µes para apenas os fixos
                accordionOrder = ['minhas-tarefas', 'lista-favoritos'];
                
                // Salvar altera√ß√µes
                saveTarefasPorPessoa();
                saveAccordionOrder();
                
                // Renderizar novamente
                renderAccordion();
                
                showStatus('Dados do Word limpos com sucesso!');
            }
            closeSidebar();
        }

        document.getElementById("search").addEventListener("input", function () {
            renderAccordion(this.value.toLowerCase());
        });

        document.getElementById("upload").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    mammoth.extractRawText({ arrayBuffer: e.target.result }).then((result) => {
                        const lines = result.value.split("\n");
                        let current = "";
                        tarefasPorPessoa = {};

                        lines.forEach((line) => {
                            line = line.trim();
                            if (line.length === 0) return;
                            
                            // Detectar t√≠tulos: uma palavra, primeira letra mai√∫scula
                            if (/^[A-Z√Å√â√ç√ì√ö√É√ï√á][a-z√°√©√≠√≥√∫√£√µ√ß]*$/.test(line)) {
                                current = line;
                                tarefasPorPessoa[current] = [];
                                // Adicionar √† ordem se n√£o existir
                                if (!accordionOrder.includes(current)) {
                                    accordionOrder.push(current);
                                }
                            } else if (current && line.length > 0) {
                                // Limpar marcadores de lista e adicionar tarefa
                                const cleanLine = line.replace(/^[‚Ä¢\-\*]\s*/, '').trim();
                                if (cleanLine.length > 0) {
                                    tarefasPorPessoa[current].push(cleanLine);
                                }
                            }
                        });
                        
                        saveTarefasPorPessoa();
                        saveAccordionOrder();
                        renderAccordion();
                        showStatus('Documento carregado com sucesso!');
                    }).catch(error => {
                        console.error('Erro ao processar documento:', error);
                        showStatus('Erro ao processar documento Word', true);
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        });

        document.addEventListener("keydown", function (e) {
            if (e.ctrlKey && e.key === "n") {
                e.preventDefault();
                openTaskModal();
            }
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registrado com sucesso:', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker falhou ao registrar:', err);
                    });
            });
        }

        // Detectar instala√ß√£o PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Instalar App';
            installBtn.className = 'menu-button';
            installBtn.style.position = 'fixed';
            installBtn.style.bottom = '70px';
            installBtn.style.right = '20px';
            installBtn.style.zIndex = '1000';
            
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA instalado');
                        showStatus('PWA instalado com sucesso!');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                });
            });
            
            document.body.appendChild(installBtn);
        });

        // Inicializar aplica√ß√£o
        async function init() {
            showStatus('Inicializando aplica√ß√£o...', false);
            
            loadAccordionStates();
            
            const sqliteInitialized = await initSQLite();
            if (sqliteInitialized) {
                const data = loadFromSQLite();
                minhasTarefas = data.minhasTarefas;
                favoritos = data.favoritos;
                tarefasPorPessoa = data.tarefasPorPessoa;
                accordionOrder = data.accordionOrder;
                showStatus('SQLite carregado com sucesso!');
            } else {
                minhasTarefas = JSON.parse(localStorage.getItem("minhasTarefas") || "[]");
                favoritos = JSON.parse(localStorage.getItem("favoritos") || "[]");
                tarefasPorPessoa = JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}");
                accordionOrder = JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]');
                showStatus('Usando localStorage como backup', true);
            }
            
            renderAccordion();
        }

        init();
    </script>
</body>
</html>
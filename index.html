<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarefas Segunda</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007BFF">
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      padding-bottom: 60px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
    }
    .logo {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      background-image: url('logo_compact.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    h1 {
      color: #333;
      margin: 0;
      font-size: 2.2em;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    #search {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
      flex: 1;
      max-width: 400px;
      min-width: 200px;
    }
    .accordion {
      background-color: #fff;
      border-radius: 5px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .accordion.dragging {
      opacity: 0.5;
    }
    .accordion-header {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      padding: 15px;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .accordion-header-content {
      display: flex;
      align-items: center;
      flex: 1;
    }
    .drag-handle {
      cursor: move;
      margin-right: 10px;
      padding: 5px;
      border-radius: 3px;
      background: rgba(255,255,255,0.2);
      font-size: 14px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
    }
    .drag-handle:hover {
      background: rgba(255,255,255,0.3);
    }
    .accordion-title {
      flex: 1;
      margin-right: 10px;
    }
    .accordion-title input {
      background: transparent;
      border: none;
      color: white;
      font-weight: bold;
      font-size: inherit;
      width: 100%;
      outline: none;
      display: none;
    }
    .accordion-title input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    .edit-btn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 5px;
      border-radius: 3px;
      font-size: 14px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    .edit-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    .accordion-content {
      display: none;
      padding: 15px;
      border-top: 1px solid #ccc;
    }
    .accordion-content ul {
      list-style: none;
      padding: 0;
    }
    .accordion-content li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 8px;
      border-radius: 3px;
      position: relative;
    }
    .accordion-content li:hover {
      background-color: #f8f9fa;
    }
    .accordion-content li.dragging {
      opacity: 0.5;
    }
    .task-drag-handle {
      cursor: move;
      margin-right: 8px;
      padding: 2px 5px;
      border-radius: 3px;
      background: #e9ecef;
      font-size: 12px;
      color: #666;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
    }
    .task-drag-handle:hover {
      background: #dee2e6;
    }
    .task-text {
      flex: 1;
      margin-left: 8px;
      min-width: 200px;
    }
    .task-actions {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }
    .highlight {
      background: yellow;
    }
    .star {
      cursor: pointer;
      margin-right: 8px;
      color: gray;
    }
    .star.favorited {
      color: gold;
    }
    .trash-icon {
      cursor: pointer;
      margin-right: 8px;
      color: #dc3545;
    }
    .confirm-icon {
      cursor: pointer;
      margin-right: 8px;
      color: gray;
    }
    .confirm-icon.completed {
      color: #28a745;
    }
    #export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #007BFF;
      color: white;
    }
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    .btn-warning {
      background-color: #ffc107;
      color: black;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    .btn-info {
      background-color: #17a2b8;
      color: white;
    }
    .btn:hover {
      opacity: 0.8;
    }
    
    /* Bot√µes de a√ß√£o mobile otimizados */
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      padding: 0;
      margin: 2px;
    }
    
    .action-btn-success {
      background-color: #28a745;
    }
    
    .action-btn-primary {
      background-color: #007BFF;
    }
    
    .action-btn-danger {
      background-color: #dc3545;
    }
    
    .action-btn-warning {
      background-color: #ffc107;
      color: black;
    }
    
    /* Responsivo para desktop */
    @media (min-width: 768px) {
      .action-btn {
        width: auto;
        height: auto;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
      }
      
      .action-btn::before {
        content: attr(data-text);
      }
    }
    
    /* Mobile - apenas √≠cones */
    @media (max-width: 767px) {
      .task-actions {
        gap: 2px;
      }
      
      .action-btn::before {
        content: attr(data-icon);
      }
      
      .task-text {
        min-width: 150px;
        margin-bottom: 5px;
      }
      
      .accordion-content li {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .task-actions {
        align-self: flex-end;
        margin-top: 5px;
      }
    }
    
    .task-form {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: none;
    }
    .task-form input, .task-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
    }
    .task-form textarea {
      height: 80px;
      resize: vertical;
    }
    .form-buttons {
      display: flex;
      gap: 10px;
    }
    .edit-form {
      background: #fff3cd;
      padding: 10px;
      border-radius: 3px;
      margin-top: 5px;
      display: none;
    }
    .edit-form input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      margin-bottom: 5px;
    }
    .status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: #28a745;
      color: white;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    .status.error {
      background: #dc3545;
    }
    
    /* Drag and Drop styles */
    .drop-zone {
      min-height: 50px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      margin: 10px 0;
      padding: 10px;
      text-align: center;
      color: #666;
      display: none;
    }
    .drop-zone.active {
      display: block;
      border-color: #007BFF;
      background-color: #f0f8ff;
    }
    .drop-zone.hover {
      border-color: #28a745;
      background-color: #f0fff0;
    }
    
    /* Linha de posi√ß√£o para drag and drop */
    .drop-indicator {
      height: 3px;
      background-color: #007BFF;
      margin: 5px 0;
      border-radius: 2px;
      display: none;
      opacity: 0.8;
    }
    .drop-indicator.active {
      display: block;
    }
    
    /* Rodap√© */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      padding: 10px 20px;
      text-align: center;
      font-size: 12px;
      color: #6c757d;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="status" class="status">PWA Instalado!</div>
  
  <div class="header">
    <div class="logo"></div>
    <h1>Tarefas Segunda</h1>
  </div>
  
  <div class="controls">
    <input type="text" id="search" placeholder="Buscar tarefas...">
  </div>
  
  <div id="export-buttons">
    <input type="file" id="upload" accept=".docx" class="btn btn-primary" style="display: none;">
    <button class="btn btn-info" onclick="document.getElementById('upload').click()">üìÑ Carregar Documento Word</button>
    <button class="btn btn-primary" onclick="exportFavoritosJSON()">Exportar Favoritos + Minhas Tarefas (JSON)</button>
    <button class="btn btn-primary" onclick="exportFavoritosCSV()">Exportar Favoritos (CSV)</button>
    <button class="btn btn-success" onclick="exportDatabase()">Backup SQLite</button>
    <button class="btn btn-warning" onclick="importDatabase()">Restaurar SQLite</button>
    <button class="btn btn-danger" onclick="clearWordData()">üóëÔ∏è Limpar Dados do Word</button>
  </div>

  <div id="accordion-container"></div>

  <div class="footer">
    Tarefas Segunda v1.0.5 - 08/07/2025
  </div>

  <script>
    let tarefasPorPessoa = {};
    let db = null;
    let SQL = null;
    let sqliteReady = false;
    let accordionOrder = ['minhas-tarefas', 'lista-favoritos']; // Ordem dos colapses
    let draggedElement = null;
    let draggedType = null; // 'accordion' ou 'task'
    let draggedIndex = -1; // Para ordena√ß√£o de tarefas

    // Fun√ß√£o para mostrar status
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = isError ? 'status error' : 'status';
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    // Inicializar SQLite com melhor tratamento de erros
    async function initSQLite() {
      try {
        if (!window.initSqlJs) {
          await loadSqlJs();
        }
        
        SQL = await window.initSqlJs({
          locateFile: file => {
            if (file.endsWith('.wasm')) {
              return 'sql-wasm.wasm';
            }
            return file;
          }
        });
        
        const savedDb = localStorage.getItem('sqliteDb');
        if (savedDb) {
          try {
            const uint8Array = new Uint8Array(JSON.parse(savedDb));
            db = new SQL.Database(uint8Array);
          } catch (error) {
            console.warn('Erro ao carregar banco salvo, criando novo:', error);
            db = new SQL.Database();
            createTables();
          }
        } else {
          db = new SQL.Database();
          createTables();
        }
        
        sqliteReady = true;
        console.log('SQLite inicializado com sucesso');
        return true;
      } catch (error) {
        console.error('Erro ao inicializar SQLite:', error);
        sqliteReady = false;
        showStatus('SQLite n√£o dispon√≠vel, usando localStorage', true);
        return false;
      }
    }

    function loadSqlJs() {
      return new Promise((resolve, reject) => {
        if (window.initSqlJs) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'sql-wasm.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function createTables() {
      if (!db) return;
      
      try {
        db.run(`
          CREATE TABLE IF NOT EXISTS minhas_tarefas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            titulo TEXT NOT NULL,
            descricao TEXT,
            concluida INTEGER DEFAULT 0,
            data_criacao TEXT,
            ordem INTEGER DEFAULT 0
          )
        `);
        
        db.run(`
          CREATE TABLE IF NOT EXISTS favoritos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            pessoa TEXT NOT NULL,
            tarefa TEXT NOT NULL
          )
        `);
        
        db.run(`
          CREATE TABLE IF NOT EXISTS tarefas_por_pessoa (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            pessoa TEXT NOT NULL,
            tarefa TEXT NOT NULL
          )
        `);
        
        db.run(`
          CREATE TABLE IF NOT EXISTS accordion_order (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            accordion_id TEXT NOT NULL,
            position INTEGER NOT NULL
          )
        `);
      } catch (error) {
        console.error('Erro ao criar tabelas:', error);
      }
    }

    function saveDatabase() {
      if (db && sqliteReady) {
        try {
          const data = db.export();
          localStorage.setItem('sqliteDb', JSON.stringify(Array.from(data)));
        } catch (error) {
          console.error('Erro ao salvar banco:', error);
        }
      }
    }

    function saveTarefasPorPessoa() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM tarefas_por_pessoa");
          for (let pessoa in tarefasPorPessoa) {
            tarefasPorPessoa[pessoa].forEach(tarefa => {
              db.run("INSERT INTO tarefas_por_pessoa (pessoa, tarefa) VALUES (?, ?)", [pessoa, tarefa]);
            });
          }
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar tarefasPorPessoa no SQLite:', error);
          localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
        }
      } else {
        localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
      }
    }

    function saveAccordionOrder() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM accordion_order");
          accordionOrder.forEach((id, index) => {
            db.run("INSERT INTO accordion_order (accordion_id, position) VALUES (?, ?)", [id, index]);
          });
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar ordem dos acorde√µes:', error);
          localStorage.setItem("accordionOrder", JSON.stringify(accordionOrder));
        }
      } else {
        localStorage.setItem("accordionOrder", JSON.stringify(accordionOrder));
      }
    }

    function loadFromSQLite() {
      if (!db || !sqliteReady) {
        return { 
          minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
          favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
          tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}"),
          accordionOrder: JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]')
        };
      }
      
      try {
        const tarefasStmt = db.prepare("SELECT * FROM minhas_tarefas ORDER BY ordem ASC");
        const favoritosStmt = db.prepare("SELECT * FROM favoritos");
        const tarefasPorPessoaStmt = db.prepare("SELECT * FROM tarefas_por_pessoa");
        const orderStmt = db.prepare("SELECT * FROM accordion_order ORDER BY position");
        
        const minhasTarefas = [];
        while (tarefasStmt.step()) {
          const row = tarefasStmt.getAsObject();
          minhasTarefas.push({
            id: row.id,
            titulo: row.titulo,
            descricao: row.descricao,
            concluida: row.concluida === 1,
            dataCreacao: row.data_criacao,
            ordem: row.ordem || 0
          });
        }
        
        const favoritos = [];
        while (favoritosStmt.step()) {
          const row = favoritosStmt.getAsObject();
          favoritos.push({
            pessoa: row.pessoa,
            tarefa: row.tarefa
          });
        }
        
        const tarefasPorPessoa = {};
        while (tarefasPorPessoaStmt.step()) {
          const row = tarefasPorPessoaStmt.getAsObject();
          if (!tarefasPorPessoa[row.pessoa]) {
            tarefasPorPessoa[row.pessoa] = [];
          }
          tarefasPorPessoa[row.pessoa].push(row.tarefa);
        }
        
        const accordionOrder = [];
        while (orderStmt.step()) {
          const row = orderStmt.getAsObject();
          accordionOrder.push(row.accordion_id);
        }
        
        // Se n√£o h√° ordem salva, usar padr√£o
        if (accordionOrder.length === 0) {
          accordionOrder.push('minhas-tarefas', 'lista-favoritos');
        }
        
        tarefasStmt.free();
        favoritosStmt.free();
        tarefasPorPessoaStmt.free();
        orderStmt.free();
        
        return { minhasTarefas, favoritos, tarefasPorPessoa, accordionOrder };
      } catch (error) {
        console.error('Erro ao carregar do SQLite:', error);
        return { 
          minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
          favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
          tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}"),
          accordionOrder: JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]')
        };
      }
    }

    let minhasTarefas = [];
    let favoritos = [];

    function saveFavoritos() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM favoritos");
          favoritos.forEach(fav => {
            db.run("INSERT INTO favoritos (pessoa, tarefa) VALUES (?, ?)", [fav.pessoa, fav.tarefa]);
          });
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar favoritos no SQLite:', error);
          localStorage.setItem("favoritos", JSON.stringify(favoritos));
        }
      } else {
        localStorage.setItem("favoritos", JSON.stringify(favoritos));
      }
    }

    function saveMinhasTarefas() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM minhas_tarefas");
          minhasTarefas.forEach((tarefa, index) => {
            db.run("INSERT INTO minhas_tarefas (id, titulo, descricao, concluida, data_criacao, ordem) VALUES (?, ?, ?, ?, ?, ?)", 
              [tarefa.id, tarefa.titulo, tarefa.descricao, tarefa.concluida ? 1 : 0, tarefa.dataCreacao, index]);
          });
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar tarefas no SQLite:', error);
          localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
        }
      } else {
        localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
      }
    }

    function adicionarTarefa(titulo, descricao) {
      const novaTarefa = {
        id: Date.now(),
        titulo: titulo,
        descricao: descricao,
        concluida: false,
        dataCreacao: new Date().toLocaleDateString("pt-BR"),
        ordem: minhasTarefas.length
      };
      minhasTarefas.push(novaTarefa);
      saveMinhasTarefas();
      renderAccordion(document.getElementById("search").value.toLowerCase());
    }

    function editarTarefa(id, novoTitulo, novaDescricao) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        tarefa.titulo = novoTitulo;
        tarefa.descricao = novaDescricao;
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function excluirTarefa(id) {
      if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
        minhasTarefas = minhasTarefas.filter((t) => t.id !== id);
        // Reordenar
        minhasTarefas.forEach((tarefa, index) => {
          tarefa.ordem = index;
        });
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function toggleConcluida(id) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        tarefa.concluida = !tarefa.concluida;
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function editAccordionTitle(accordionId) {
      const titleSpan = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title span`);
      const titleInput = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title input`);
      
      if (titleSpan && titleInput) {
        titleSpan.style.display = 'none';
        titleInput.style.display = 'block';
        titleInput.value = titleSpan.textContent;
        titleInput.focus();
        titleInput.select();
      }
    }

    function saveAccordionTitle(accordionId, newTitle) {
      if (newTitle.trim() && newTitle !== accordionId) {
        renameAccordion(accordionId, newTitle.trim());
      } else {
        // Cancelar edi√ß√£o
        const titleSpan = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title span`);
        const titleInput = document.querySelector(`[data-accordion-id="${accordionId}"] .accordion-title input`);
        
        if (titleSpan && titleInput) {
          titleInput.style.display = 'none';
          titleSpan.style.display = 'block';
        }
      }
    }

    function renameAccordion(oldName, newName) {
      if (tarefasPorPessoa[oldName]) {
        tarefasPorPessoa[newName] = tarefasPorPessoa[oldName];
        delete tarefasPorPessoa[oldName];
        
        // Atualizar favoritos
        favoritos.forEach(fav => {
          if (fav.pessoa === oldName) {
            fav.pessoa = newName;
          }
        });
        
        // Atualizar ordem dos acorde√µes
        const index = accordionOrder.indexOf(oldName);
        if (index !== -1) {
          accordionOrder[index] = newName;
        }
        
        saveTarefasPorPessoa();
        saveFavoritos();
        saveAccordionOrder();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    // Drag and Drop para acorde√µes
    function handleAccordionDragStart(e) {
      draggedElement = e.target.closest('.accordion');
      draggedType = 'accordion';
      draggedElement.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedElement.outerHTML);
    }

    function handleAccordionDragEnd(e) {
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement = null;
        draggedType = null;
      }
      // Remover todos os indicadores
      document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.classList.remove('active');
      });
    }

    function handleAccordionDragOver(e) {
      e.preventDefault();
      if (draggedType !== 'accordion') return;
      
      const targetAccordion = e.target.closest('.accordion');
      if (!targetAccordion || targetAccordion === draggedElement) return;
      
      // Remover indicadores anteriores
      document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.classList.remove('active');
      });
      
      // Determinar posi√ß√£o (acima ou abaixo)
      const rect = targetAccordion.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      const isAbove = e.clientY < midY;
      
      // Mostrar indicador
      const indicator = isAbove ? 
        targetAccordion.querySelector('.drop-indicator-top') :
        targetAccordion.querySelector('.drop-indicator-bottom');
      
      if (indicator) {
        indicator.classList.add('active');
      }
    }

    function handleAccordionDrop(e) {
      e.preventDefault();
      if (draggedType !== 'accordion') return;
      
      const targetAccordion = e.target.closest('.accordion');
      if (!targetAccordion || targetAccordion === draggedElement) return;
      
      const draggedId = draggedElement.getAttribute('data-accordion-id');
      const targetId = targetAccordion.getAttribute('data-accordion-id');
      
      // Determinar posi√ß√£o
      const rect = targetAccordion.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      const isAbove = e.clientY < midY;
      
      const draggedIndex = accordionOrder.indexOf(draggedId);
      const targetIndex = accordionOrder.indexOf(targetId);
      
      if (draggedIndex !== -1 && targetIndex !== -1) {
        accordionOrder.splice(draggedIndex, 1);
        const newIndex = isAbove ? targetIndex : targetIndex + 1;
        accordionOrder.splice(newIndex, 0, draggedId);
        saveAccordionOrder();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    // Drag and Drop para tarefas
    function handleTaskDragStart(e) {
      draggedElement = e.target.closest('li');
      draggedType = 'task';
      draggedIndex = Array.from(draggedElement.parentNode.children).indexOf(draggedElement);
      draggedElement.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      
      // Mostrar zonas de drop
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.classList.add('active');
      });
    }

    function handleTaskDragEnd(e) {
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement = null;
        draggedType = null;
        draggedIndex = -1;
      }
      // Esconder zonas de drop
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.classList.remove('active', 'hover');
      });
      // Remover indicadores
      document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.classList.remove('active');
      });
    }

    function handleTaskDragOver(e) {
      e.preventDefault();
      if (draggedType !== 'task') return;
      
      const targetLi = e.target.closest('li');
      if (!targetLi || targetLi === draggedElement) return;
      
      // Remover indicadores anteriores
      document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.classList.remove('active');
      });
      
      // Determinar posi√ß√£o (acima ou abaixo)
      const rect = targetLi.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      const isAbove = e.clientY < midY;
      
      // Mostrar indicador
      const indicator = isAbove ? 
        targetLi.querySelector('.drop-indicator-top') :
        targetLi.querySelector('.drop-indicator-bottom');
      
      if (indicator) {
        indicator.classList.add('active');
      }
    }

    function handleTaskReorder(e) {
      e.preventDefault();
      if (draggedType !== 'task') return;
      
      const targetLi = e.target.closest('li');
      if (!targetLi || targetLi === draggedElement) return;
      
      const sourceAccordion = draggedElement.getAttribute('data-source');
      const targetAccordion = targetLi.getAttribute('data-source');
      
      // Se for reordena√ß√£o dentro de "Minhas Tarefas"
      if (sourceAccordion === 'minhas-tarefas' && targetAccordion === 'minhas-tarefas') {
        const draggedTaskId = parseInt(draggedElement.getAttribute('data-task-id'));
        const targetIndex = Array.from(targetLi.parentNode.children).indexOf(targetLi);
        
        // Determinar posi√ß√£o
        const rect = targetLi.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        const isAbove = e.clientY < midY;
        
        const newIndex = isAbove ? targetIndex : targetIndex + 1;
        
        // Reordenar array
        const draggedTask = minhasTarefas.find(t => t.id === draggedTaskId);
        if (draggedTask) {
          minhasTarefas.splice(draggedIndex, 1);
          minhasTarefas.splice(newIndex > draggedIndex ? newIndex - 1 : newIndex, 0, draggedTask);
          
          // Atualizar ordem
          minhasTarefas.forEach((tarefa, index) => {
            tarefa.ordem = index;
          });
          
          saveMinhasTarefas();
          renderAccordion(document.getElementById("search").value.toLowerCase());
          showStatus('Tarefa reordenada com sucesso!');
        }
      }
    }

    function handleDropZoneDragOver(e) {
      e.preventDefault();
      e.target.classList.add('hover');
    }

    function handleTaskDrop(e, targetAccordion) {
      e.preventDefault();
      e.target.classList.remove('hover');
      
      if (draggedType !== 'task') return;
      
      try {
        const taskId = draggedElement.getAttribute('data-task-id');
        const source = draggedElement.getAttribute('data-source');
        
        if (source === 'minhas-tarefas' && targetAccordion !== 'minhas-tarefas') {
          // Mover de Minhas Tarefas para outro acorde√£o
          const tarefa = minhasTarefas.find(t => t.id == taskId);
          if (tarefa) {
            if (targetAccordion === 'lista-favoritos') {
              favoritos.push({pessoa: 'Minhas Tarefas', tarefa: tarefa.titulo});
              saveFavoritos();
            } else {
              if (!tarefasPorPessoa[targetAccordion]) {
                tarefasPorPessoa[targetAccordion] = [];
              }
              tarefasPorPessoa[targetAccordion].push(tarefa.titulo);
              saveTarefasPorPessoa();
            }
            minhasTarefas = minhasTarefas.filter(t => t.id != taskId);
            // Reordenar
            minhasTarefas.forEach((tarefa, index) => {
              tarefa.ordem = index;
            });
            saveMinhasTarefas();
          }
        } else if (source !== 'minhas-tarefas' && targetAccordion === 'minhas-tarefas') {
          // Mover de outro acorde√£o para Minhas Tarefas
          let tarefaTexto = '';
          
          if (source === 'lista-favoritos') {
            const fav = favoritos.find(f => f.tarefa === taskId);
            if (fav) {
              tarefaTexto = fav.tarefa;
              favoritos = favoritos.filter(f => f.tarefa !== taskId);
              saveFavoritos();
            }
          } else {
            if (tarefasPorPessoa[source]) {
              const index = tarefasPorPessoa[source].indexOf(taskId);
              if (index !== -1) {
                tarefaTexto = taskId;
                tarefasPorPessoa[source].splice(index, 1);
                saveTarefasPorPessoa();
              }
            }
          }
          
          if (tarefaTexto) {
            adicionarTarefa(tarefaTexto, `Movida de ${source}`);
          }
        }
        
        renderAccordion(document.getElementById("search").value.toLowerCase());
        showStatus('Tarefa movida com sucesso!');
      } catch (error) {
        console.error('Erro ao mover tarefa:', error);
        showStatus('Erro ao mover tarefa', true);
      }
    }

    function createMinhasTarefasAccordion(filtro = "") {
      const filteredMinhasTarefas = minhasTarefas.filter(
        (t) =>
          t.titulo.toLowerCase().includes(filtro) ||
          t.descricao.toLowerCase().includes(filtro)
      );

      if (filtro && filteredMinhasTarefas.length === 0) {
        return null;
      }

      const acc = document.createElement("div");
      acc.className = "accordion";
      acc.setAttribute('data-accordion-id', 'minhas-tarefas');

      // Indicadores de drop para acorde√£o
      const dropIndicatorTop = document.createElement("div");
      dropIndicatorTop.className = "drop-indicator drop-indicator-top";
      
      const dropIndicatorBottom = document.createElement("div");
      dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

      const header = document.createElement("div");
      header.className = "accordion-header";
      
      const headerContent = document.createElement("div");
      headerContent.className = "accordion-header-content";
      
      const title = document.createElement("div");
      title.className = "accordion-title";
      title.innerHTML = `<span>Minhas Tarefas (${filteredMinhasTarefas.length})</span>`;
      
      const newTaskBtn = document.createElement("button");
      newTaskBtn.className = "btn btn-success";
      newTaskBtn.textContent = "+ Nova Tarefa";
      newTaskBtn.onclick = toggleTaskForm;
      
      headerContent.appendChild(title);
      header.appendChild(headerContent);
      header.appendChild(newTaskBtn);
      
      header.onclick = function (e) {
        if (e.target.tagName !== "BUTTON") {
          this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
        }
      };

      const content = document.createElement("div");
      content.className = "accordion-content";
      content.style.display = "block";

      const taskForm = document.createElement("div");
      taskForm.className = "task-form";
      taskForm.id = "task-form";
      taskForm.innerHTML = `
        <h4>Nova Tarefa</h4>
        <input type="text" id="task-title" placeholder="T√≠tulo da tarefa" required>
        <textarea id="task-description" placeholder="Descri√ß√£o da tarefa (opcional)"></textarea>
        <div class="form-buttons">
          <button class="btn btn-success" onclick="salvarNovaTarefa()">Salvar</button>
          <button class="btn btn-warning" onclick="cancelarNovaTarefa()">Cancelar</button>
        </div>
      `;

      const dropZone = document.createElement("div");
      dropZone.className = "drop-zone";
      dropZone.innerHTML = "Solte tarefas aqui para mover para Minhas Tarefas";
      dropZone.addEventListener('dragover', handleDropZoneDragOver);
      dropZone.addEventListener('drop', (e) => handleTaskDrop(e, 'minhas-tarefas'));

      const ul = document.createElement("ul");

      // Ordenar tarefas por ordem
      filteredMinhasTarefas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

      filteredMinhasTarefas.forEach((tarefa) => {
        const li = document.createElement("li");
        li.style.textDecoration = tarefa.concluida ? "line-through" : "none";
        li.style.opacity = tarefa.concluida ? "0.6" : "1";
        li.setAttribute('data-task-id', tarefa.id);
        li.setAttribute('data-source', 'minhas-tarefas');

        // Indicadores de drop para tarefa
        const taskDropIndicatorTop = document.createElement("div");
        taskDropIndicatorTop.className = "drop-indicator drop-indicator-top";
        
        const taskDropIndicatorBottom = document.createElement("div");
        taskDropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

        const dragHandle = document.createElement("div");
        dragHandle.className = "task-drag-handle";
        dragHandle.innerHTML = "‚ãÆ‚ãÆ";
        dragHandle.draggable = true;
        dragHandle.addEventListener('dragstart', handleTaskDragStart);
        dragHandle.addEventListener('dragend', handleTaskDragEnd);

        const taskContent = document.createElement("div");
        taskContent.className = "task-text";
        taskContent.innerHTML = `
          <strong>${tarefa.titulo}</strong>
          ${tarefa.descricao ? `<br><small>${tarefa.descricao}</small>` : ""}
          <br><small style="color: #666;">Criada em: ${tarefa.dataCreacao}</small>
        `;

        const actions = document.createElement("div");
        actions.className = "task-actions";
        actions.innerHTML = `
          <button class="action-btn action-btn-${tarefa.concluida ? 'warning' : 'success'}" 
                  data-icon="${tarefa.concluida ? '‚Ü©' : '‚úì'}"
                  data-text="${tarefa.concluida ? 'Reabrir' : 'Concluir'}"
                  onclick="toggleConcluida(${tarefa.id})">
          </button>
          <button class="action-btn action-btn-primary" 
                  data-icon="‚úé"
                  data-text="Editar"
                  onclick="editarTarefaForm(${tarefa.id})">
          </button>
          <button class="action-btn action-btn-danger" 
                  data-icon="‚úï"
                  data-text="Excluir"
                  onclick="excluirTarefa(${tarefa.id})">
          </button>
        `;

        const editForm = document.createElement("div");
        editForm.className = "edit-form";
        editForm.id = `edit-form-${tarefa.id}`;
        editForm.innerHTML = `
          <input type="text" id="edit-title-${tarefa.id}" value="${tarefa.titulo}" placeholder="T√≠tulo">
          <input type="text" id="edit-desc-${tarefa.id}" value="${tarefa.descricao || ""}" placeholder="Descri√ß√£o">
          <div class="form-buttons">
            <button class="btn btn-success" onclick="salvarEdicao(${tarefa.id})">Salvar</button>
            <button class="btn btn-warning" onclick="cancelarEdicao(${tarefa.id})">Cancelar</button>
          </div>
        `;

        li.appendChild(taskDropIndicatorTop);
        li.appendChild(dragHandle);
        li.appendChild(taskContent);
        li.appendChild(actions);
        li.appendChild(editForm);
        li.appendChild(taskDropIndicatorBottom);
        
        li.addEventListener('dragover', handleTaskDragOver);
        li.addEventListener('drop', handleTaskReorder);
        ul.appendChild(li);
      });

      content.appendChild(taskForm);
      content.appendChild(dropZone);
      content.appendChild(ul);
      
      acc.appendChild(dropIndicatorTop);
      acc.appendChild(header);
      acc.appendChild(content);
      acc.appendChild(dropIndicatorBottom);

      return acc;
    }

    function toggleTaskForm() {
      const form = document.getElementById("task-form");
      form.style.display = form.style.display === "block" ? "none" : "block";
      if (form.style.display === "block") {
        document.getElementById("task-title").focus();
      }
    }

    function salvarNovaTarefa() {
      const titulo = document.getElementById("task-title").value.trim();
      const descricao = document.getElementById("task-description").value.trim();

      if (!titulo) {
        alert("Por favor, insira um t√≠tulo para a tarefa.");
        return;
      }

      adicionarTarefa(titulo, descricao);

      document.getElementById("task-title").value = "";
      document.getElementById("task-description").value = "";
      document.getElementById("task-form").style.display = "none";
    }

    function cancelarNovaTarefa() {
      document.getElementById("task-title").value = "";
      document.getElementById("task-description").value = "";
      document.getElementById("task-form").style.display = "none";
    }

    function editarTarefaForm(id) {
      const editForm = document.getElementById(`edit-form-${id}`);
      editForm.style.display = editForm.style.display === "block" ? "none" : "block";
    }

    function salvarEdicao(id) {
      const novoTitulo = document.getElementById(`edit-title-${id}`).value.trim();
      const novaDescricao = document.getElementById(`edit-desc-${id}`).value.trim();

      if (!novoTitulo) {
        alert("Por favor, insira um t√≠tulo para a tarefa.");
        return;
      }

      editarTarefa(id, novoTitulo, novaDescricao);
      document.getElementById(`edit-form-${id}`).style.display = "none";
    }

    function cancelarEdicao(id) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        document.getElementById(`edit-title-${id}`).value = tarefa.titulo;
        document.getElementById(`edit-desc-${id}`).value = tarefa.descricao || "";
      }
      document.getElementById(`edit-form-${id}`).style.display = "none";
    }

    function createTrashIcon(pessoa, tarefa, tipoLista) {
      const trash = document.createElement("span");
      trash.className = "trash-icon";
      trash.innerHTML = "üóëÔ∏è";
      trash.onclick = function () {
        if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
          if (tipoLista === "favoritos") {
            favoritos = favoritos.filter(
              (f) => !(f.pessoa === pessoa && f.tarefa === tarefa)
            );
            saveFavoritos();
          } else if (tipoLista === "tarefasPorPessoa") {
            tarefasPorPessoa[pessoa] = tarefasPorPessoa[pessoa].filter(
              (t) => t !== tarefa
            );
            saveTarefasPorPessoa();
          }
          renderAccordion(document.getElementById("search").value.toLowerCase());
        }
      };
      return trash;
    }

    function createConfirmIcon(pessoa, tarefa) {
      const confirmIcon = document.createElement("span");
      confirmIcon.className = "confirm-icon";
      confirmIcon.innerHTML = "‚úîÔ∏è";
      confirmIcon.onclick = function () {
        favoritos = favoritos.filter(
          (f) => !(f.pessoa === pessoa && f.tarefa === tarefa)
        );
        saveFavoritos();

        adicionarTarefa(tarefa, `Tarefa importada de ${pessoa}`);

        renderAccordion(document.getElementById("search").value.toLowerCase());
      };
      return confirmIcon;
    }

    function renderAccordion(filtro = "") {
      const container = document.getElementById("accordion-container");
      container.innerHTML = "";

      // Renderizar acorde√µes na ordem salva
      accordionOrder.forEach(accordionId => {
        if (accordionId === 'minhas-tarefas') {
          const minhasTarefasAccordion = createMinhasTarefasAccordion(filtro);
          if (minhasTarefasAccordion) {
            container.appendChild(minhasTarefasAccordion);
          }
        } else if (accordionId === 'lista-favoritos') {
          const favoritosFiltrados = favoritos.filter(
            (f) =>
              f.tarefa.toLowerCase().includes(filtro) ||
              f.pessoa.toLowerCase().includes(filtro)
          );
          if (favoritosFiltrados.length > 0 || !filtro) {
            const acc = document.createElement("div");
            acc.className = "accordion";
            acc.setAttribute('data-accordion-id', 'lista-favoritos');
            
            // Indicadores de drop
            const dropIndicatorTop = document.createElement("div");
            dropIndicatorTop.className = "drop-indicator drop-indicator-top";
            
            const dropIndicatorBottom = document.createElement("div");
            dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";
            
            const header = document.createElement("div");
            header.className = "accordion-header";
            
            const headerContent = document.createElement("div");
            headerContent.className = "accordion-header-content";
            
            const title = document.createElement("div");
            title.className = "accordion-title";
            title.innerHTML = `<span>Lista de Favoritos</span>`;
            
            headerContent.appendChild(title);
            header.appendChild(headerContent);
            
            header.onclick = function (e) {
              if (e.target.tagName !== "BUTTON") {
                this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
              }
            };
            
            const content = document.createElement("div");
            content.className = "accordion-content";
            
            const dropZone = document.createElement("div");
            dropZone.className = "drop-zone";
            dropZone.innerHTML = "Solte tarefas aqui para adicionar aos favoritos";
            dropZone.addEventListener('dragover', handleDropZoneDragOver);
            dropZone.addEventListener('drop', (e) => handleTaskDrop(e, 'lista-favoritos'));
            
            const ul = document.createElement("ul");
            favoritosFiltrados.forEach(({ pessoa, tarefa }) => {
              const li = document.createElement("li");
              li.setAttribute('data-task-id', tarefa);
              li.setAttribute('data-source', 'lista-favoritos');
              
              // Indicadores de drop para tarefa
              const taskDropIndicatorTop = document.createElement("div");
              taskDropIndicatorTop.className = "drop-indicator drop-indicator-top";
              
              const taskDropIndicatorBottom = document.createElement("div");
              taskDropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

              const dragHandle = document.createElement("div");
              dragHandle.className = "task-drag-handle";
              dragHandle.innerHTML = "‚ãÆ‚ãÆ";
              dragHandle.draggable = true;
              dragHandle.addEventListener('dragstart', handleTaskDragStart);
              dragHandle.addEventListener('dragend', handleTaskDragEnd);
              
              const star = createStar(pessoa, tarefa);
              const trash = createTrashIcon(pessoa, tarefa, "favoritos");
              const confirmIcon = createConfirmIcon(pessoa, tarefa);
              const taskText = document.createElement("div");
              taskText.className = "task-text";
              taskText.textContent = tarefa;
              
              li.appendChild(taskDropIndicatorTop);
              li.appendChild(dragHandle);
              li.appendChild(star);
              li.appendChild(trash);
              li.appendChild(confirmIcon);
              li.appendChild(taskText);
              li.appendChild(taskDropIndicatorBottom);
              
              li.addEventListener('dragover', handleTaskDragOver);
              ul.appendChild(li);
            });
            
            content.appendChild(dropZone);
            content.appendChild(ul);
            
            acc.appendChild(dropIndicatorTop);
            acc.appendChild(header);
            acc.appendChild(content);
            acc.appendChild(dropIndicatorBottom);
            
            acc.addEventListener('dragover', handleAccordionDragOver);
            acc.addEventListener('drop', handleAccordionDrop);
            
            container.appendChild(acc);
          }
        } else if (tarefasPorPessoa[accordionId]) {
          const tarefasFiltradas = tarefasPorPessoa[accordionId].filter(
            (t) => t.toLowerCase().includes(filtro)
          );
          if (tarefasFiltradas.length > 0 || accordionId.toLowerCase().includes(filtro)) {
            const acc = document.createElement("div");
            acc.className = "accordion";
            acc.setAttribute('data-accordion-id', accordionId);

            // Indicadores de drop
            const dropIndicatorTop = document.createElement("div");
            dropIndicatorTop.className = "drop-indicator drop-indicator-top";
            
            const dropIndicatorBottom = document.createElement("div");
            dropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

            const header = document.createElement("div");
            header.className = "accordion-header";
            
            const headerContent = document.createElement("div");
            headerContent.className = "accordion-header-content";
            
            const dragHandle = document.createElement("div");
            dragHandle.className = "drag-handle";
            dragHandle.innerHTML = "‚ãÆ‚ãÆ";
            dragHandle.draggable = true;
            dragHandle.addEventListener('dragstart', handleAccordionDragStart);
            dragHandle.addEventListener('dragend', handleAccordionDragEnd);
            
            const title = document.createElement("div");
            title.className = "accordion-title";
            title.innerHTML = `
              <span>${accordionId}</span>
              <input type="text" value="${accordionId}" style="display: none;">
            `;
            
            const editBtn = document.createElement("button");
            editBtn.className = "edit-btn";
            editBtn.innerHTML = "‚úé";
            editBtn.onclick = (e) => {
              e.stopPropagation();
              editAccordionTitle(accordionId);
            };
            
            // Event listeners para o input
            const titleInput = title.querySelector('input');
            titleInput.addEventListener('blur', () => {
              saveAccordionTitle(accordionId, titleInput.value);
            });
            titleInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                titleInput.blur();
              }
            });
            
            headerContent.appendChild(dragHandle);
            headerContent.appendChild(title);
            header.appendChild(headerContent);
            header.appendChild(editBtn);
            
            header.onclick = function (e) {
              if (e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT" && !e.target.classList.contains('drag-handle')) {
                this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
              }
            };

            const content = document.createElement("div");
            content.className = "accordion-content";
            
            const dropZone = document.createElement("div");
            dropZone.className = "drop-zone";
            dropZone.innerHTML = `Solte tarefas aqui para mover para ${accordionId}`;
            dropZone.addEventListener('dragover', handleDropZoneDragOver);
            dropZone.addEventListener('drop', (e) => handleTaskDrop(e, accordionId));
            
            const ul = document.createElement("ul");
            tarefasFiltradas.forEach((tarefa) => {
              const li = document.createElement("li");
              li.setAttribute('data-task-id', tarefa);
              li.setAttribute('data-source', accordionId);
              
              // Indicadores de drop para tarefa
              const taskDropIndicatorTop = document.createElement("div");
              taskDropIndicatorTop.className = "drop-indicator drop-indicator-top";
              
              const taskDropIndicatorBottom = document.createElement("div");
              taskDropIndicatorBottom.className = "drop-indicator drop-indicator-bottom";

              const dragHandle = document.createElement("div");
              dragHandle.className = "task-drag-handle";
              dragHandle.innerHTML = "‚ãÆ‚ãÆ";
              dragHandle.draggable = true;
              dragHandle.addEventListener('dragstart', handleTaskDragStart);
              dragHandle.addEventListener('dragend', handleTaskDragEnd);
              
              const star = createStar(accordionId, tarefa);
              const trash = createTrashIcon(accordionId, tarefa, "tarefasPorPessoa");
              const taskText = document.createElement("div");
              taskText.className = "task-text";

              if (filtro) {
                const regex = new RegExp(filtro, "gi");
                const textoDestacado = tarefa.replace(
                  regex,
                  (match) => 
                    `<span class="highlight">${match}</span>`
                );
                taskText.innerHTML = textoDestacado;
              } else {
                taskText.textContent = tarefa;
              }

              li.appendChild(taskDropIndicatorTop);
              li.appendChild(dragHandle);
              li.appendChild(star);
              li.appendChild(trash);
              li.appendChild(taskText);
              li.appendChild(taskDropIndicatorBottom);
              
              li.addEventListener('dragover', handleTaskDragOver);
              ul.appendChild(li);
            });
            
            content.appendChild(dropZone);
            content.appendChild(ul);

            acc.appendChild(dropIndicatorTop);
            acc.appendChild(header);
            acc.appendChild(content);
            acc.appendChild(dropIndicatorBottom);
            
            acc.addEventListener('dragover', handleAccordionDragOver);
            acc.addEventListener('drop', handleAccordionDrop);
            
            container.appendChild(acc);
          }
        }
      });

      // Adicionar acorde√µes que n√£o est√£o na ordem salva
      for (let pessoa in tarefasPorPessoa) {
        if (!accordionOrder.includes(pessoa)) {
          accordionOrder.push(pessoa);
          saveAccordionOrder();
        }
      }
    }

    function createStar(pessoa, tarefa) {
      const star = document.createElement("span");
      star.className = "star";
      star.innerHTML = "‚òÖ";
      if (favoritos.find((f) => f.pessoa === pessoa && f.tarefa === tarefa)) {
        star.classList.add("favorited");
      }
      star.onclick = function () {
        const idx = favoritos.findIndex(
          (f) => f.pessoa === pessoa && f.tarefa === tarefa
        );
        if (idx >= 0) {
          favoritos.splice(idx, 1);
        } else {
          favoritos.push({ pessoa, tarefa });
        }
        saveFavoritos();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      };
      return star;
    }

    function exportFavoritosJSON() {
      const exportData = {
        favoritos: favoritos,
        minhasTarefas: minhasTarefas,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "favoritos_e_minhas_tarefas.json";
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Favoritos e Minhas Tarefas exportados!');
    }

    function exportFavoritosCSV() {
      // Usar BOM UTF-8 para garantir acentua√ß√£o correta
      let csv = "\uFEFF";
      csv += "Respons√°vel,Tarefa\n";
      favoritos.forEach(({ pessoa, tarefa }) => {
        // Escapar aspas duplas e envolver em aspas
        const pessoaEscapada = `"${pessoa.replace(/"/g, '""')}"`;
        const tarefaEscapada = `"${tarefa.replace(/"/g, '""')}"`;
        csv += `${pessoaEscapada},${tarefaEscapada}\n`;
      });
      
      const blob = new Blob([csv], { 
        type: "text/csv;charset=utf-8;" 
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "favoritos.csv";
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Favoritos exportados em CSV!');
    }

    function exportDatabase() {
      saveTarefasPorPessoa();
      saveAccordionOrder();
      
      if (db && sqliteReady) {
        try {
          const data = db.export();
          const blob = new Blob([data], { type: "application/x-sqlite3" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tarefas_segunda_backup.sqlite";
          a.click();
          URL.revokeObjectURL(url);
          
          showStatus('Backup SQLite criado com sucesso!');
        } catch (error) {
          console.error('Erro ao exportar banco:', error);
          showStatus('Erro ao criar backup SQLite', true);
        }
      } else {
        showStatus("SQLite n√£o dispon√≠vel. Criando backup JSON...", true);
        const backup = {
          minhasTarefas: minhasTarefas,
          favoritos: favoritos,
          tarefasPorPessoa: tarefasPorPessoa,
          accordionOrder: accordionOrder,
          timestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "tarefas_segunda_backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    async function importDatabase() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.sqlite,.json';
      input.onchange = async function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async function(e) {
            try {
              if (file.name.endsWith('.sqlite')) {
                if (!sqliteReady) {
                  showStatus('Inicializando SQLite...', false);
                  await initSQLite();
                }
                
                if (sqliteReady && SQL) {
                  try {
                    const uint8Array = new Uint8Array(e.target.result);
                    db = new SQL.Database(uint8Array);
                    const data = loadFromSQLite();
                    minhasTarefas = data.minhasTarefas;
                    favoritos = data.favoritos;
                    tarefasPorPessoa = data.tarefasPorPessoa;
                    accordionOrder = data.accordionOrder;
                    renderAccordion();
                    showStatus('Banco SQLite restaurado com sucesso!');
                  } catch (sqlError) {
                    console.error('Erro ao processar arquivo SQLite:', sqlError);
                    showStatus('Erro: Arquivo SQLite inv√°lido ou corrompido', true);
                  }
                } else {
                  showStatus('Erro: SQLite n√£o est√° dispon√≠vel', true);
                }
              } else if (file.name.endsWith('.json')) {
                try {
                  const backup = JSON.parse(e.target.result);
                  minhasTarefas = backup.minhasTarefas || [];
                  favoritos = backup.favoritos || [];
                  tarefasPorPessoa = backup.tarefasPorPessoa || {};
                  accordionOrder = backup.accordionOrder || ['minhas-tarefas', 'lista-favoritos'];
                  saveMinhasTarefas();
                  saveFavoritos();
                  saveTarefasPorPessoa();
                  saveAccordionOrder();
                  renderAccordion();
                  showStatus('Backup JSON restaurado com sucesso!');
                } catch (jsonError) {
                  console.error('Erro ao processar arquivo JSON:', jsonError);
                  showStatus('Erro: Arquivo JSON inv√°lido', true);
                }
              }
            } catch (error) {
              console.error('Erro geral ao restaurar backup:', error);
              showStatus('Erro ao restaurar backup: ' + error.message, true);
            }
          };
          
          if (file.name.endsWith('.sqlite')) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }
        }
      };
      input.click();
    }

    function clearWordData() {
      if (confirm("Tem certeza que deseja limpar todos os dados carregados do Word? Esta a√ß√£o n√£o pode ser desfeita.\n\nOs dados de 'Minhas Tarefas' e 'Lista de Favoritos' ser√£o preservados.")) {
        // Limpar dados do Word
        tarefasPorPessoa = {};
        
        // Resetar ordem dos acorde√µes para apenas os fixos
        accordionOrder = ['minhas-tarefas', 'lista-favoritos'];
        
        // Salvar altera√ß√µes
        saveTarefasPorPessoa();
        saveAccordionOrder();
        
        // Renderizar novamente
        renderAccordion();
        
        showStatus('Dados do Word limpos com sucesso!');
      }
    }

    document.getElementById("search").addEventListener("input", function () {
      renderAccordion(this.value.toLowerCase());
    });

    document.getElementById("upload").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          mammoth.extractRawText({ arrayBuffer: e.target.result }).then((result) => {
            const lines = result.value.split("\n");
            let current = "";
            tarefasPorPessoa = {};

            lines.forEach((line) => {
              line = line.trim();
              if (line.length === 0) return;
              
              // Detectar t√≠tulos: uma palavra, primeira letra mai√∫scula
              if (/^[A-Z√Å√â√ç√ì√ö√É√ï√á][a-z√°√©√≠√≥√∫√£√µ√ß]*$/.test(line)) {
                current = line;
                tarefasPorPessoa[current] = [];
                // Adicionar √† ordem se n√£o existir
                if (!accordionOrder.includes(current)) {
                  accordionOrder.push(current);
                }
              } else if (current && line.length > 0) {
                // Limpar marcadores de lista e adicionar tarefa
                const cleanLine = line.replace(/^[‚Ä¢\-\*]\s*/, '').trim();
                if (cleanLine.length > 0) {
                  tarefasPorPessoa[current].push(cleanLine);
                }
              }
            });
            
            saveTarefasPorPessoa();
            saveAccordionOrder();
            renderAccordion();
            showStatus('Documento carregado com sucesso!');
          }).catch(error => {
            console.error('Erro ao processar documento:', error);
            showStatus('Erro ao processar documento Word', true);
          });
        };
        reader.readAsArrayBuffer(file);
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.ctrlKey && e.key === "n") {
        e.preventDefault();
        toggleTaskForm();
      }
    });

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registrado com sucesso:', registration.scope);
          }, function(err) {
            console.log('ServiceWorker falhou ao registrar:', err);
          });
      });
    }

    // Detectar instala√ß√£o PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      const installBtn = document.createElement('button');
      installBtn.textContent = 'Instalar App';
      installBtn.className = 'btn btn-success';
      installBtn.style.position = 'fixed';
      installBtn.style.bottom = '70px';
      installBtn.style.right = '20px';
      installBtn.style.zIndex = '1000';
      
      installBtn.addEventListener('click', () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('PWA instalado');
            showStatus('PWA instalado com sucesso!');
          }
          deferredPrompt = null;
          installBtn.remove();
        });
      });
      
      document.body.appendChild(installBtn);
    });

    // Inicializar aplica√ß√£o
    async function init() {
      showStatus('Inicializando aplica√ß√£o...', false);
      
      const sqliteInitialized = await initSQLite();
      if (sqliteInitialized) {
        const data = loadFromSQLite();
        minhasTarefas = data.minhasTarefas;
        favoritos = data.favoritos;
        tarefasPorPessoa = data.tarefasPorPessoa;
        accordionOrder = data.accordionOrder;
        showStatus('SQLite carregado com sucesso!');
      } else {
        minhasTarefas = JSON.parse(localStorage.getItem("minhasTarefas") || "[]");
        favoritos = JSON.parse(localStorage.getItem("favoritos") || "[]");
        tarefasPorPessoa = JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}");
        accordionOrder = JSON.parse(localStorage.getItem("accordionOrder") || '["minhas-tarefas", "lista-favoritos"]');
        showStatus('Usando localStorage como backup', true);
      }
      
      renderAccordion();
    }

    init();
  </script>
</body>
</html>


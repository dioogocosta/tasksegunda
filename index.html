<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tarefas Segunda</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007BFF">
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
    }
    .logo {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      background-image: url('logo_compact.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    h1 {
      color: #333;
      margin: 0;
      font-size: 2.2em;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    #upload, #search {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #upload {
      flex: 1;
      min-width: 200px;
    }
    #search {
      flex: 2;
      min-width: 300px;
    }
    .accordion {
      background-color: #fff;
      border-radius: 5px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .accordion-header {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      padding: 15px;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-content {
      display: none;
      padding: 15px;
      border-top: 1px solid #ccc;
    }
    .accordion-content ul {
      list-style: none;
      padding: 0;
    }
    .accordion-content li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .task-text {
      flex: 1;
      margin-left: 8px;
      min-width: 200px;
    }
    .task-actions {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }
    .highlight {
      background: yellow;
    }
    .star {
      cursor: pointer;
      margin-right: 8px;
      color: gray;
    }
    .star.favorited {
      color: gold;
    }
    .trash-icon {
      cursor: pointer;
      margin-right: 8px;
      color: #dc3545;
    }
    .confirm-icon {
      cursor: pointer;
      margin-right: 8px;
      color: gray;
    }
    .confirm-icon.completed {
      color: #28a745;
    }
    #export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #007BFF;
      color: white;
    }
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    .btn-warning {
      background-color: #ffc107;
      color: black;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    .btn:hover {
      opacity: 0.8;
    }
    
    /* Botões de ação mobile otimizados */
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      padding: 0;
      margin: 2px;
    }
    
    .action-btn-success {
      background-color: #28a745;
    }
    
    .action-btn-primary {
      background-color: #007BFF;
    }
    
    .action-btn-danger {
      background-color: #dc3545;
    }
    
    .action-btn-warning {
      background-color: #ffc107;
      color: black;
    }
    
    /* Responsivo para desktop */
    @media (min-width: 768px) {
      .action-btn {
        width: auto;
        height: auto;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
      }
      
      .action-btn::before {
        content: attr(data-text);
      }
    }
    
    /* Mobile - apenas ícones */
    @media (max-width: 767px) {
      .task-actions {
        gap: 2px;
      }
      
      .action-btn::before {
        content: attr(data-icon);
      }
      
      .task-text {
        min-width: 150px;
        margin-bottom: 5px;
      }
      
      .accordion-content li {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .task-actions {
        align-self: flex-end;
        margin-top: 5px;
      }
    }
    
    .task-form {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: none;
    }
    .task-form input, .task-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
    }
    .task-form textarea {
      height: 80px;
      resize: vertical;
    }
    .form-buttons {
      display: flex;
      gap: 10px;
    }
    .edit-form {
      background: #fff3cd;
      padding: 10px;
      border-radius: 3px;
      margin-top: 5px;
      display: none;
    }
    .edit-form input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      margin-bottom: 5px;
    }
    .status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: #28a745;
      color: white;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    .status.error {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <div id="status" class="status">PWA Instalado!</div>
  
  <div class="header">
    <div class="logo"></div>
    <h1>Tarefas Segunda</h1>
  </div>
  
  <div class="controls">
    <input type="file" id="upload" accept=".docx" class="btn btn-primary">
    <input type="text" id="search" placeholder="Buscar tarefas...">
  </div>
  
  <div id="export-buttons">
    <button class="btn btn-primary" onclick="exportFavoritosJSON()">Exportar Favoritos (JSON)</button>
    <button class="btn btn-primary" onclick="exportFavoritosCSV()">Exportar Favoritos (CSV)</button>
    <button class="btn btn-success" onclick="exportDatabase()">Backup SQLite</button>
    <button class="btn btn-warning" onclick="importDatabase()">Restaurar SQLite</button>
  </div>

  <div id="accordion-container"></div>

  <script>
    let tarefasPorPessoa = {};
    let db = null;
    let SQL = null;
    let sqliteReady = false;

    // Função para mostrar status
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = isError ? 'status error' : 'status';
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    // Inicializar SQLite com melhor tratamento de erros
    async function initSQLite() {
      try {
        // Carregar sql.js dinamicamente
        if (!window.initSqlJs) {
          await loadSqlJs();
        }
        
        SQL = await window.initSqlJs({
          locateFile: file => {
            // Tentar diferentes caminhos para o arquivo WASM
            if (file.endsWith('.wasm')) {
              return 'sql-wasm.wasm';
            }
            return file;
          }
        });
        
        // Tentar carregar banco existente do localStorage
        const savedDb = localStorage.getItem('sqliteDb');
        if (savedDb) {
          try {
            const uint8Array = new Uint8Array(JSON.parse(savedDb));
            db = new SQL.Database(uint8Array);
          } catch (error) {
            console.warn('Erro ao carregar banco salvo, criando novo:', error);
            db = new SQL.Database();
            createTables();
          }
        } else {
          db = new SQL.Database();
          createTables();
        }
        
        sqliteReady = true;
        console.log('SQLite inicializado com sucesso');
        return true;
      } catch (error) {
        console.error('Erro ao inicializar SQLite:', error);
        sqliteReady = false;
        showStatus('SQLite não disponível, usando localStorage', true);
        return false;
      }
    }

    // Carregar sql.js dinamicamente
    function loadSqlJs() {
      return new Promise((resolve, reject) => {
        if (window.initSqlJs) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'sql-wasm.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // Criar tabelas
    function createTables() {
      if (!db) return;
      
      try {
        db.run(`
          CREATE TABLE IF NOT EXISTS minhas_tarefas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            titulo TEXT NOT NULL,
            descricao TEXT,
            concluida INTEGER DEFAULT 0,
            data_criacao TEXT
          )
        `);
        
        db.run(`
          CREATE TABLE IF NOT EXISTS favoritos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            pessoa TEXT NOT NULL,
            tarefa TEXT NOT NULL
          )
        `);
        
        db.run(`
          CREATE TABLE IF NOT EXISTS tarefas_por_pessoa (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            pessoa TEXT NOT NULL,
            tarefa TEXT NOT NULL
          )
        `);
      } catch (error) {
        console.error('Erro ao criar tabelas:', error);
      }
    }

    // Salvar banco no localStorage
    function saveDatabase() {
      if (db && sqliteReady) {
        try {
          const data = db.export();
          localStorage.setItem('sqliteDb', JSON.stringify(Array.from(data)));
        } catch (error) {
          console.error('Erro ao salvar banco:', error);
        }
      }
    }

    // Salvar tarefasPorPessoa no SQLite
    function saveTarefasPorPessoa() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM tarefas_por_pessoa");
          for (let pessoa in tarefasPorPessoa) {
            tarefasPorPessoa[pessoa].forEach(tarefa => {
              db.run("INSERT INTO tarefas_por_pessoa (pessoa, tarefa) VALUES (?, ?)", [pessoa, tarefa]);
            });
          }
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar tarefasPorPessoa no SQLite:', error);
          localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
        }
      } else {
        localStorage.setItem("tarefasPorPessoa", JSON.stringify(tarefasPorPessoa));
      }
    }

    // Carregar dados do SQLite
    function loadFromSQLite() {
      if (!db || !sqliteReady) {
        return { 
          minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
          favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
          tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}")
        };
      }
      
      try {
        const tarefasStmt = db.prepare("SELECT * FROM minhas_tarefas");
        const favoritosStmt = db.prepare("SELECT * FROM favoritos");
        const tarefasPorPessoaStmt = db.prepare("SELECT * FROM tarefas_por_pessoa");
        
        const minhasTarefas = [];
        while (tarefasStmt.step()) {
          const row = tarefasStmt.getAsObject();
          minhasTarefas.push({
            id: row.id,
            titulo: row.titulo,
            descricao: row.descricao,
            concluida: row.concluida === 1,
            dataCreacao: row.data_criacao
          });
        }
        
        const favoritos = [];
        while (favoritosStmt.step()) {
          const row = favoritosStmt.getAsObject();
          favoritos.push({
            pessoa: row.pessoa,
            tarefa: row.tarefa
          });
        }
        
        const tarefasPorPessoa = {};
        while (tarefasPorPessoaStmt.step()) {
          const row = tarefasPorPessoaStmt.getAsObject();
          if (!tarefasPorPessoa[row.pessoa]) {
            tarefasPorPessoa[row.pessoa] = [];
          }
          tarefasPorPessoa[row.pessoa].push(row.tarefa);
        }
        
        tarefasStmt.free();
        favoritosStmt.free();
        tarefasPorPessoaStmt.free();
        
        return { minhasTarefas, favoritos, tarefasPorPessoa };
      } catch (error) {
        console.error('Erro ao carregar do SQLite:', error);
        return { 
          minhasTarefas: JSON.parse(localStorage.getItem("minhasTarefas") || "[]"),
          favoritos: JSON.parse(localStorage.getItem("favoritos") || "[]"),
          tarefasPorPessoa: JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}")
        };
      }
    }

    // Fallback para localStorage
    let minhasTarefas = [];
    let favoritos = [];

    function saveFavoritos() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM favoritos");
          favoritos.forEach(fav => {
            db.run("INSERT INTO favoritos (pessoa, tarefa) VALUES (?, ?)", [fav.pessoa, fav.tarefa]);
          });
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar favoritos no SQLite:', error);
          localStorage.setItem("favoritos", JSON.stringify(favoritos));
        }
      } else {
        localStorage.setItem("favoritos", JSON.stringify(favoritos));
      }
    }

    function saveMinhasTarefas() {
      if (db && sqliteReady) {
        try {
          db.run("DELETE FROM minhas_tarefas");
          minhasTarefas.forEach(tarefa => {
            db.run("INSERT INTO minhas_tarefas (id, titulo, descricao, concluida, data_criacao) VALUES (?, ?, ?, ?, ?)", 
              [tarefa.id, tarefa.titulo, tarefa.descricao, tarefa.concluida ? 1 : 0, tarefa.dataCreacao]);
          });
          saveDatabase();
        } catch (error) {
          console.error('Erro ao salvar tarefas no SQLite:', error);
          localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
        }
      } else {
        localStorage.setItem("minhasTarefas", JSON.stringify(minhasTarefas));
      }
    }

    function adicionarTarefa(titulo, descricao) {
      const novaTarefa = {
        id: Date.now(),
        titulo: titulo,
        descricao: descricao,
        concluida: false,
        dataCreacao: new Date().toLocaleDateString("pt-BR"),
      };
      minhasTarefas.push(novaTarefa);
      saveMinhasTarefas();
      renderAccordion(document.getElementById("search").value.toLowerCase());
    }

    function editarTarefa(id, novoTitulo, novaDescricao) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        tarefa.titulo = novoTitulo;
        tarefa.descricao = novaDescricao;
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function excluirTarefa(id) {
      if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
        minhasTarefas = minhasTarefas.filter((t) => t.id !== id);
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function toggleConcluida(id) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        tarefa.concluida = !tarefa.concluida;
        saveMinhasTarefas();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      }
    }

    function createMinhasTarefasAccordion(filtro = "") {
      const filteredMinhasTarefas = minhasTarefas.filter(
        (t) =>
          t.titulo.toLowerCase().includes(filtro) ||
          t.descricao.toLowerCase().includes(filtro)
      );

      if (filtro && filteredMinhasTarefas.length === 0) {
        return null;
      }

      const acc = document.createElement("div");
      acc.className = "accordion";

      const header = document.createElement("div");
      header.className = "accordion-header";
      header.innerHTML = `
        <span>Minhas Tarefas (${filteredMinhasTarefas.length})</span>
        <button class="btn btn-success" onclick="toggleTaskForm()">+ Nova Tarefa</button>
      `;
      header.onclick = function (e) {
        if (e.target.tagName !== "BUTTON") {
          this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
        }
      };

      const content = document.createElement("div");
      content.className = "accordion-content";
      content.style.display = "block";

      const taskForm = document.createElement("div");
      taskForm.className = "task-form";
      taskForm.id = "task-form";
      taskForm.innerHTML = `
        <h4>Nova Tarefa</h4>
        <input type="text" id="task-title" placeholder="Título da tarefa" required>
        <textarea id="task-description" placeholder="Descrição da tarefa (opcional)"></textarea>
        <div class="form-buttons">
          <button class="btn btn-success" onclick="salvarNovaTarefa()">Salvar</button>
          <button class="btn btn-warning" onclick="cancelarNovaTarefa()">Cancelar</button>
        </div>
      `;

      const ul = document.createElement("ul");

      filteredMinhasTarefas.forEach((tarefa) => {
        const li = document.createElement("li");
        li.style.textDecoration = tarefa.concluida ? "line-through" : "none";
        li.style.opacity = tarefa.concluida ? "0.6" : "1";

        const taskContent = document.createElement("div");
        taskContent.className = "task-text";
        taskContent.innerHTML = `
          <strong>${tarefa.titulo}</strong>
          ${tarefa.descricao ? `<br><small>${tarefa.descricao}</small>` : ""}
          <br><small style="color: #666;">Criada em: ${tarefa.dataCreacao}</small>
        `;

        const actions = document.createElement("div");
        actions.className = "task-actions";
        actions.innerHTML = `
          <button class="action-btn action-btn-${tarefa.concluida ? 'warning' : 'success'}" 
                  data-icon="${tarefa.concluida ? '↩' : '✓'}"
                  data-text="${tarefa.concluida ? 'Reabrir' : 'Concluir'}"
                  onclick="toggleConcluida(${tarefa.id})">
          </button>
          <button class="action-btn action-btn-primary" 
                  data-icon="✎"
                  data-text="Editar"
                  onclick="editarTarefaForm(${tarefa.id})">
          </button>
          <button class="action-btn action-btn-danger" 
                  data-icon="✕"
                  data-text="Excluir"
                  onclick="excluirTarefa(${tarefa.id})">
          </button>
        `;

        const editForm = document.createElement("div");
        editForm.className = "edit-form";
        editForm.id = `edit-form-${tarefa.id}`;
        editForm.innerHTML = `
          <input type="text" id="edit-title-${tarefa.id}" value="${tarefa.titulo}" placeholder="Título">
          <input type="text" id="edit-desc-${tarefa.id}" value="${tarefa.descricao || ""}" placeholder="Descrição">
          <div class="form-buttons">
            <button class="btn btn-success" onclick="salvarEdicao(${tarefa.id})">Salvar</button>
            <button class="btn btn-warning" onclick="cancelarEdicao(${tarefa.id})">Cancelar</button>
          </div>
        `;

        li.appendChild(taskContent);
        li.appendChild(actions);
        li.appendChild(editForm);
        ul.appendChild(li);
      });

      content.appendChild(taskForm);
      content.appendChild(ul);
      acc.appendChild(header);
      acc.appendChild(content);

      return acc;
    }

    function toggleTaskForm() {
      const form = document.getElementById("task-form");
      form.style.display = form.style.display === "block" ? "none" : "block";
      if (form.style.display === "block") {
        document.getElementById("task-title").focus();
      }
    }

    function salvarNovaTarefa() {
      const titulo = document.getElementById("task-title").value.trim();
      const descricao = document.getElementById("task-description").value.trim();

      if (!titulo) {
        alert("Por favor, insira um título para a tarefa.");
        return;
      }

      adicionarTarefa(titulo, descricao);

      document.getElementById("task-title").value = "";
      document.getElementById("task-description").value = "";
      document.getElementById("task-form").style.display = "none";
    }

    function cancelarNovaTarefa() {
      document.getElementById("task-title").value = "";
      document.getElementById("task-description").value = "";
      document.getElementById("task-form").style.display = "none";
    }

    function editarTarefaForm(id) {
      const editForm = document.getElementById(`edit-form-${id}`);
      editForm.style.display = editForm.style.display === "block" ? "none" : "block";
    }

    function salvarEdicao(id) {
      const novoTitulo = document.getElementById(`edit-title-${id}`).value.trim();
      const novaDescricao = document.getElementById(`edit-desc-${id}`).value.trim();

      if (!novoTitulo) {
        alert("Por favor, insira um título para a tarefa.");
        return;
      }

      editarTarefa(id, novoTitulo, novaDescricao);
      document.getElementById(`edit-form-${id}`).style.display = "none";
    }

    function cancelarEdicao(id) {
      const tarefa = minhasTarefas.find((t) => t.id === id);
      if (tarefa) {
        document.getElementById(`edit-title-${id}`).value = tarefa.titulo;
        document.getElementById(`edit-desc-${id}`).value = tarefa.descricao || "";
      }
      document.getElementById(`edit-form-${id}`).style.display = "none";
    }

    function createTrashIcon(pessoa, tarefa, tipoLista) {
      const trash = document.createElement("span");
      trash.className = "trash-icon";
      trash.innerHTML = "🗑️";
      trash.onclick = function () {
        if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
          if (tipoLista === "favoritos") {
            favoritos = favoritos.filter(
              (f) => !(f.pessoa === pessoa && f.tarefa === tarefa)
            );
            saveFavoritos();
          } else if (tipoLista === "tarefasPorPessoa") {
            tarefasPorPessoa[pessoa] = tarefasPorPessoa[pessoa].filter(
              (t) => t !== tarefa
            );
            saveTarefasPorPessoa();
          }
          renderAccordion(document.getElementById("search").value.toLowerCase());
        }
      };
      return trash;
    }

    function createConfirmIcon(pessoa, tarefa) {
      const confirmIcon = document.createElement("span");
      confirmIcon.className = "confirm-icon";
      confirmIcon.innerHTML = "✔️";
      confirmIcon.onclick = function () {
        favoritos = favoritos.filter(
          (f) => !(f.pessoa === pessoa && f.tarefa === tarefa)
        );
        saveFavoritos();

        adicionarTarefa(tarefa, `Tarefa importada de ${pessoa}`);

        renderAccordion(document.getElementById("search").value.toLowerCase());
      };
      return confirmIcon;
    }

    function renderAccordion(filtro = "") {
      const container = document.getElementById("accordion-container");
      container.innerHTML = "";

      const minhasTarefasAccordion = createMinhasTarefasAccordion(filtro);
      if (minhasTarefasAccordion) {
        container.appendChild(minhasTarefasAccordion);
      }

      const favoritosFiltrados = favoritos.filter(
        (f) =>
          f.tarefa.toLowerCase().includes(filtro) ||
          f.pessoa.toLowerCase().includes(filtro)
      );
      if (favoritosFiltrados.length > 0 || !filtro) {
        const acc = document.createElement("div");
        acc.className = "accordion";
        const header = document.createElement("div");
        header.className = "accordion-header";
        header.textContent = "Lista de Favoritos";
        header.onclick = function () {
          this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
        };
        const content = document.createElement("div");
        content.className = "accordion-content";
        const ul = document.createElement("ul");
        favoritosFiltrados.forEach(({ pessoa, tarefa }) => {
          const li = document.createElement("li");
          const star = createStar(pessoa, tarefa);
          const trash = createTrashIcon(pessoa, tarefa, "favoritos");
          const confirmIcon = createConfirmIcon(pessoa, tarefa);
          const taskText = document.createElement("div");
          taskText.className = "task-text";
          taskText.textContent = tarefa;
          li.appendChild(star);
          li.appendChild(trash);
          li.appendChild(confirmIcon);
          li.appendChild(taskText);
          ul.appendChild(li);
        });
        content.appendChild(ul);
        acc.appendChild(header);
        acc.appendChild(content);
        container.appendChild(acc);
      }

      for (let pessoa in tarefasPorPessoa) {
        const tarefasFiltradas = tarefasPorPessoa[pessoa].filter(
          (t) => t.toLowerCase().includes(filtro)
        );
        if (tarefasFiltradas.length > 0 || pessoa.toLowerCase().includes(filtro)) {
          const acc = document.createElement("div");
          acc.className = "accordion";

          const header = document.createElement("div");
          header.className = "accordion-header";
          header.textContent = pessoa;
          header.onclick = function () {
            this.nextElementSibling.style.display = this.nextElementSibling.style.display === "block" ? "none" : "block";
          };

          const content = document.createElement("div");
          content.className = "accordion-content";
          const ul = document.createElement("ul");
          tarefasFiltradas.forEach((tarefa) => {
            const li = document.createElement("li");
            const star = createStar(pessoa, tarefa);
            const trash = createTrashIcon(pessoa, tarefa, "tarefasPorPessoa");
            const taskText = document.createElement("div");
            taskText.className = "task-text";

            if (filtro) {
              const regex = new RegExp(filtro, "gi");
              const textoDestacado = tarefa.replace(
                regex,
                (match) => 
                  `<span class="highlight">${match}</span>`
              );
              taskText.innerHTML = textoDestacado;
            } else {
              taskText.textContent = tarefa;
            }

            li.appendChild(star);
            li.appendChild(trash);
            li.appendChild(taskText);
            ul.appendChild(li);
          });
          content.appendChild(ul);

          acc.appendChild(header);
          acc.appendChild(content);
          container.appendChild(acc);
        }
      }
    }

    function createStar(pessoa, tarefa) {
      const star = document.createElement("span");
      star.className = "star";
      star.innerHTML = "★";
      if (favoritos.find((f) => f.pessoa === pessoa && f.tarefa === tarefa)) {
        star.classList.add("favorited");
      }
      star.onclick = function () {
        const idx = favoritos.findIndex(
          (f) => f.pessoa === pessoa && f.tarefa === tarefa
        );
        if (idx >= 0) {
          favoritos.splice(idx, 1);
        } else {
          favoritos.push({ pessoa, tarefa });
        }
        saveFavoritos();
        renderAccordion(document.getElementById("search").value.toLowerCase());
      };
      return star;
    }

    function exportFavoritosJSON() {
      const blob = new Blob([JSON.stringify(favoritos, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "favoritos.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportFavoritosCSV() {
      let csv = "Responsável,Tarefa\n";
      favoritos.forEach(({ pessoa, tarefa }) => {
        csv += `"${pessoa}","${tarefa.replace(/"/g, "\"\"")}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "favoritos.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportDatabase() {
      // Salvar tarefasPorPessoa antes do backup
      saveTarefasPorPessoa();
      
      if (db && sqliteReady) {
        try {
          const data = db.export();
          const blob = new Blob([data], { type: "application/x-sqlite3" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tarefas_segunda_backup.sqlite";
          a.click();
          URL.revokeObjectURL(url);
          
          showStatus('Backup SQLite criado com sucesso!');
        } catch (error) {
          console.error('Erro ao exportar banco:', error);
          showStatus('Erro ao criar backup SQLite', true);
        }
      } else {
        showStatus("SQLite não disponível. Criando backup JSON...", true);
        const backup = {
          minhasTarefas: minhasTarefas,
          favoritos: favoritos,
          tarefasPorPessoa: tarefasPorPessoa,
          timestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "tarefas_segunda_backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    async function importDatabase() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.sqlite,.json';
      input.onchange = async function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async function(e) {
            try {
              if (file.name.endsWith('.sqlite')) {
                // Garantir que SQLite está carregado
                if (!sqliteReady) {
                  showStatus('Inicializando SQLite...', false);
                  await initSQLite();
                }
                
                if (sqliteReady && SQL) {
                  try {
                    const uint8Array = new Uint8Array(e.target.result);
                    db = new SQL.Database(uint8Array);
                    const data = loadFromSQLite();
                    minhasTarefas = data.minhasTarefas;
                    favoritos = data.favoritos;
                    tarefasPorPessoa = data.tarefasPorPessoa;
                    renderAccordion();
                    showStatus('Banco SQLite restaurado com sucesso!');
                  } catch (sqlError) {
                    console.error('Erro ao processar arquivo SQLite:', sqlError);
                    showStatus('Erro: Arquivo SQLite inválido ou corrompido', true);
                  }
                } else {
                  showStatus('Erro: SQLite não está disponível', true);
                }
              } else if (file.name.endsWith('.json')) {
                try {
                  const backup = JSON.parse(e.target.result);
                  minhasTarefas = backup.minhasTarefas || [];
                  favoritos = backup.favoritos || [];
                  tarefasPorPessoa = backup.tarefasPorPessoa || {};
                  saveMinhasTarefas();
                  saveFavoritos();
                  saveTarefasPorPessoa();
                  renderAccordion();
                  showStatus('Backup JSON restaurado com sucesso!');
                } catch (jsonError) {
                  console.error('Erro ao processar arquivo JSON:', jsonError);
                  showStatus('Erro: Arquivo JSON inválido', true);
                }
              }
            } catch (error) {
              console.error('Erro geral ao restaurar backup:', error);
              showStatus('Erro ao restaurar backup: ' + error.message, true);
            }
          };
          
          if (file.name.endsWith('.sqlite')) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }
        }
      };
      input.click();
    }

    document.getElementById("search").addEventListener("input", function () {
      renderAccordion(this.value.toLowerCase());
    });

    document.getElementById("upload").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          mammoth.extractRawText({ arrayBuffer: e.target.result }).then((result) => {
            const lines = result.value.split("\n");
            let current = "";
            tarefasPorPessoa = {};

            lines.forEach((line) => {
              line = line.trim();
              if (line.length === 0) return;
              if (
                /^[A-ZÁÉÍÓÚÃÕÇ][a-záéíóúãõç]+(\s+[A-ZÁÉÍÓÚÃÕÇa-záéíóúãõç]+)*$/.test(
                  line
                ) && !line.includes(":")
              ) {
                current = line;
                tarefasPorPessoa[current] = [];
              } else if (current) {
                tarefasPorPessoa[current].push(line);
              }
            });
            
            // Salvar no SQLite após o upload
            saveTarefasPorPessoa();
            renderAccordion();
            showStatus('Documento carregado com sucesso!');
          }).catch(error => {
            console.error('Erro ao processar documento:', error);
            showStatus('Erro ao processar documento Word', true);
          });
        };
        reader.readAsArrayBuffer(file);
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.ctrlKey && e.key === "n") {
        e.preventDefault();
        toggleTaskForm();
      }
    });

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registrado com sucesso:', registration.scope);
          }, function(err) {
            console.log('ServiceWorker falhou ao registrar:', err);
          });
      });
    }

    // Detectar instalação PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Mostrar botão de instalação personalizado
      const installBtn = document.createElement('button');
      installBtn.textContent = 'Instalar App';
      installBtn.className = 'btn btn-success';
      installBtn.style.position = 'fixed';
      installBtn.style.bottom = '20px';
      installBtn.style.right = '20px';
      installBtn.style.zIndex = '1000';
      
      installBtn.addEventListener('click', () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('PWA instalado');
            showStatus('PWA instalado com sucesso!');
          }
          deferredPrompt = null;
          installBtn.remove();
        });
      });
      
      document.body.appendChild(installBtn);
    });

    // Inicializar aplicação
    async function init() {
      showStatus('Inicializando aplicação...', false);
      
      const sqliteInitialized = await initSQLite();
      if (sqliteInitialized) {
        const data = loadFromSQLite();
        minhasTarefas = data.minhasTarefas;
        favoritos = data.favoritos;
        tarefasPorPessoa = data.tarefasPorPessoa;
        showStatus('SQLite carregado com sucesso!');
      } else {
        // Carregar do localStorage como fallback
        minhasTarefas = JSON.parse(localStorage.getItem("minhasTarefas") || "[]");
        favoritos = JSON.parse(localStorage.getItem("favoritos") || "[]");
        tarefasPorPessoa = JSON.parse(localStorage.getItem("tarefasPorPessoa") || "{}");
        showStatus('Usando localStorage como backup', true);
      }
      
      renderAccordion();
    }

    init();
  </script>
</body>
</html>

